
# å˜—è©¦äº†è§£ VPC æœ€åŸºæœ¬å…ƒä»¶ã€‚
   - VPCã€regionã€avaliable zones(az), subnetã€route tableã€internet gatewayã€nat gatewayã€‚
     â˜… Insight â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  VPC å°±åƒåœ¨ AWS é›²ç«¯å»ºç«‹è‡ªå·±çš„ç§æœ‰ç¶²è·¯ï¼š
  - ä½ å¯ä»¥å®Œå…¨æ§åˆ¶ IP ç¯„åœã€å­ç¶²è·¯ã€è·¯ç”±ã€é–˜é“
  - é¡ä¼¼æ–¼åœ¨å…¬å¸å…§éƒ¨å»ºç«‹è‡ªå·±çš„è³‡æ–™ä¸­å¿ƒç¶²è·¯
  - æ˜¯ AWS ç¶²è·¯æ¶æ§‹çš„åŸºç¤
  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

  ---
  æ¶æ§‹åœ–
  ```

                          â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                          â”‚              AWS Region (ap-northeast-1)        â”‚
                          â”‚                     æ±äº¬                         â”‚
  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”             â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
  â”‚         â”‚             â”‚  â”‚            VPC (10.0.0.0/18)               â”‚  â”‚
  â”‚ Internetâ”‚â—„â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–º â”‚  â”‚                                           â”‚  â”‚
  â”‚         â”‚     IGW     â”‚  â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚  â”‚
  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  (Internet  â”‚  â”‚   â”‚    Availability Zone A (1a)         â”‚ â”‚  â”‚
               Gateway)   â”‚  â”‚   â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚ â”‚  â”‚
                          â”‚  â”‚   â”‚  â”‚ Public Subnet (10.0.0.0/20) â”‚    â”‚ â”‚  â”‚
                          â”‚  â”‚   â”‚  â”‚   â”Œâ”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”        â”‚    â”‚ â”‚  â”‚
                          â”‚  â”‚   â”‚  â”‚   â”‚ EC2 â”‚    â”‚ NAT â”‚        â”‚    â”‚ â”‚  â”‚
                          â”‚  â”‚   â”‚  â”‚   â””â”€â”€â”€â”€â”€â”˜    â”‚ GW  â”‚        â”‚    â”‚ â”‚  â”‚
                          â”‚  â”‚   â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”¬â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚ â”‚  â”‚
                          â”‚  â”‚   â”‚                    â”‚                 â”‚ â”‚  â”‚
                          â”‚  â”‚   â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚ â”‚  â”‚
                          â”‚  â”‚   â”‚  â”‚ Private Subnet (10.0.32.0/20)â”‚   â”‚ â”‚  â”‚
                          â”‚  â”‚   â”‚  â”‚   â”Œâ”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”        â”‚    â”‚ â”‚  â”‚
                          â”‚  â”‚   â”‚  â”‚   â”‚ EC2 â”‚    â”‚ RDS â”‚        â”‚    â”‚ â”‚  â”‚
                          â”‚  â”‚   â”‚  â”‚   â””â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”˜        â”‚    â”‚ â”‚  â”‚
                          â”‚  â”‚   â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚ â”‚  â”‚
                          â”‚  â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚  â”‚
                          â”‚  â”‚                                           â”‚  â”‚
                          â”‚  â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚  â”‚
                          â”‚  â”‚   â”‚    Availability Zone C (1c)         â”‚ â”‚  â”‚
                          â”‚  â”‚   â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚ â”‚  â”‚
                          â”‚  â”‚   â”‚  â”‚ Public Subnet (10.0.16.0/20)â”‚    â”‚ â”‚  â”‚
                          â”‚  â”‚   â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚ â”‚  â”‚
                          â”‚  â”‚   â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚ â”‚  â”‚
                          â”‚  â”‚   â”‚  â”‚ Private Subnet (10.0.48.0/20)â”‚   â”‚ â”‚  â”‚
                          â”‚  â”‚   â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚ â”‚  â”‚
                          â”‚  â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚  â”‚
                          â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
                          â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```
  ---
  å…ƒä»¶èªªæ˜

  | å…ƒä»¶                   | èªªæ˜                                           | é¡æ¯”             |
  |------------------------|------------------------------------------------|------------------|
  | Region                 | AWS çš„åœ°ç†å€åŸŸï¼ˆå¦‚æ±äº¬ã€æ–°åŠ å¡ï¼‰               | åœ‹å®¶/åŸå¸‚        |
  | Availability Zone (AZ) | Region å…§ç¨ç«‹çš„è³‡æ–™ä¸­å¿ƒ                        | åŸå¸‚å…§ä¸åŒçš„æ©Ÿæˆ¿ |
  | VPC                    | è™›æ“¬ç§æœ‰ç¶²è·¯ï¼Œä½ çš„å°ˆå±¬ç¶²æ®µ                     | å…¬å¸çš„å…§éƒ¨ç¶²è·¯   |
  | Subnet                 | VPC å…§çš„å­ç¶²è·¯ï¼Œå¿…é ˆåœ¨å–®ä¸€ AZ å…§               | éƒ¨é–€çš„ç¶²æ®µ       |
  | Route Table            | æ±ºå®šæµé‡æ€éº¼èµ°                                 | è·¯æ¨™/æŒ‡ç¤ºç‰Œ      |
  | Internet Gateway (IGW) | VPC é€£æ¥ Internet çš„å¤§é–€                       | å…¬å¸å°å¤–çš„å¤§é–€   |
  | NAT Gateway            | è®“ Private Subnet å¯ä»¥ã€Œå‡ºå»ã€ä½†å¤–é¢ã€Œé€²ä¸ä¾†ã€ | å–®å‘é–€           |

  ---
  Public vs Private Subnet

  | é¡å‹           | Route Table è¨­å®š                   | ç”¨é€”                     |
  |----------------|------------------------------------|--------------------------|
  | Public Subnet  | æœ‰è·¯ç”±åˆ° IGW (0.0.0.0/0 â†’ igw-xxx) | Web Serverã€Bastion Host |
  | Private Subnet | ç„¡ç›´æ¥è·¯ç”±åˆ° IGWï¼Œå¯ç¶“ NAT         | Databaseã€å…§éƒ¨æœå‹™       |

  ---
  æµé‡è·¯å¾‘ç¯„ä¾‹

  å¾ Internet å­˜å– Public Subnet çš„ EC2ï¼š

  Internet â†’ IGW â†’ Route Table â†’ Public Subnet â†’ EC2

  Private Subnet çš„ EC2 å­˜å– Internetï¼ˆä¸‹è¼‰æ›´æ–°ç­‰ï¼‰ï¼š

  EC2 (Private) â†’ Route Table â†’ NAT Gateway â†’ IGW â†’ Internet
                                 â†‘
                           (ä½æ–¼ Public Subnet)

  ---
  ```
  â˜… Insight â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  é«˜å¯ç”¨æ¶æ§‹çš„é—œéµï¼š
  - å°‡è³‡æºåˆ†æ•£åœ¨ è‡³å°‘ 2 å€‹ AZ
  - æ¯å€‹ AZ éƒ½æœ‰ Public + Private Subnet
  - AZ ä¹‹é–“çš„é€šè¨Šå»¶é²å¾ˆä½ï¼ˆåŒ Region å…§ï¼‰
  - ä¸€å€‹ AZ æ›æ‰ï¼Œå¦ä¸€å€‹ä»å¯é‹ä½œ

  å¸¸è¦‹èª¤è§£ï¼š
  - Subnet æœ¬èº«æ²’æœ‰ã€ŒPublic/Privateã€å±¬æ€§
  - æ˜¯ Route Table çš„è¨­å®š æ±ºå®šå®ƒæ˜¯ Public é‚„æ˜¯ Privateï¼
  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
```
# å¯¦ä½œé¡Œ

1. åœ¨æ±äº¬ regionï¼Œå˜—è©¦å‰µå»ºä¸€å€‹ VPCï¼Œå…¶ CIDR ç‚º 10.0.0.0/18ï¼Œç‚ºå…¶å‰µå»ºå…©å€‹ subnet ä¸¦ä¸”å…¶é®ç½©é•·åº¦ç‚º 20ï¼Œä¸¦ä¸”ä½æ–¼ä¸åŒçš„ zoneï¼Œä¸”æä¾›è©²å…©å€‹ subnet çš„ CIDRã€‚
```
  â˜… Insight â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  CIDR è¨ˆç®—é‡é»ï¼š
  - /18 = 2^(32-18) = 16,384 å€‹ IP
  - /20 = 2^(32-20) = 4,096 å€‹ IP
  - ä¸€å€‹ /18 å¯ä»¥åˆ‡æˆ 4 å€‹ /20
  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
```
```
    Subnet CIDR è¦åŠƒ

    | VPC/Subnet    | CIDR         | IP ç¯„åœ                 | å¯ç”¨ IP æ•¸ |
    |---------------|--------------|-------------------------|------------|
    | VPC           | 10.0.0.0/18  | 10.0.0.0 - 10.0.63.255  | 16,384     |
    | Subnet A (1a) | 10.0.0.0/20  | 10.0.0.0 - 10.0.15.255  | 4,091*     |
    | Subnet C (1c) | 10.0.16.0/20 | 10.0.16.0 - 10.0.31.255 | 4,091*     |
```

    æ­¥é©Ÿä¸€ï¼šå»ºç«‹ VPC

    - å»ºç«‹ VPC
    aws ec2 create-vpc \
        --cidr-block 10.0.0.0/18 \
        --region ap-northeast-1 \
        --tag-specifications 'ResourceType=vpc,Tags=[{Key=Name,Value=MyTokyoVPC}]'

    è¨˜ä¸‹è¼¸å‡ºçš„ VpcIdï¼ˆä¾‹å¦‚ï¼švpc-0abc123def456ï¼‰

    # æˆ–ç”¨è®Šæ•¸å„²å­˜
    VPC_ID=$(aws ec2 create-vpc \
        --cidr-block 10.0.0.0/18 \
        --region ap-northeast-1 \
        --query 'Vpc.VpcId' \
        --output text)

    echo "VPC ID: $VPC_ID"

    - åŠ ä¸Š Name tag
    aws ec2 create-tags \
        --resources $VPC_ID \
        --tags Key=Name,Value=MyTokyoVPC \
        --region ap-northeast-1
```
    æ­¥é©ŸäºŒï¼šæŸ¥çœ‹å¯ç”¨çš„ AZ

    aws ec2 describe-availability-zones \
        --region ap-northeast-1 \
        --query 'AvailabilityZones[*].ZoneName' \
        --output table

    æ±äº¬é€šå¸¸æœ‰ï¼šap-northeast-1a, ap-northeast-1c, ap-northeast-1d
    ---
    æ­¥é©Ÿä¸‰ï¼šå»ºç«‹ Subnet Aï¼ˆåœ¨ ap-northeast-1aï¼‰

    SUBNET_A=$(aws ec2 create-subnet \
        --vpc-id $VPC_ID \
        --cidr-block 10.0.0.0/20 \
        --availability-zone ap-northeast-1a \
        --region ap-northeast-1 \
        --query 'Subnet.SubnetId' \
        --output text)

    echo "Subnet A: $SUBNET_A"

    - åŠ ä¸Š Name tag
    aws ec2 create-tags \
        --resources $SUBNET_A \
        --tags Key=Name,Value=Subnet-AZ-A \
        --region ap-northeast-1
```
    æ­¥é©Ÿå››ï¼šå»ºç«‹ Subnet Cï¼ˆåœ¨ ap-northeast-1cï¼‰
    SUBNET_C=$(aws ec2 create-subnet \
        --vpc-id $VPC_ID \
        --cidr-block 10.0.16.0/20 \
        --availability-zone ap-northeast-1c \
        --region ap-northeast-1 \
        --query 'Subnet.SubnetId' \
        --output text)

    echo "Subnet C: $SUBNET_C"

    # åŠ ä¸Š Name tag
    aws ec2 create-tags \
        --resources $SUBNET_C \
        --tags Key=Name,Value=Subnet-AZ-C \
        --region ap-northeast-1
```

    æ­¥é©Ÿäº”ï¼šé©—è­‰
    - æŸ¥çœ‹ VPC
    aws ec2 describe-vpcs \
        --vpc-ids $VPC_ID \
        --region ap-northeast-1 \
        --query 'Vpcs[*].[VpcId,CidrBlock,Tags[?Key==`Name`].Value|[0]]' \
        --output table

    -  æŸ¥çœ‹ Subnets
    aws ec2 describe-subnets \
        --filters "Name=vpc-id,Values=$VPC_ID" \
        --region ap-northeast-1 \
        --query 'Subnets[*].[SubnetId,CidrBlock,AvailabilityZone,Tags[?Key==`Name`].Value|[0]]' \
        --output table

    - é æœŸè¼¸å‡ºï¼š
    -----------------------------------------------------------------
    |                       DescribeSubnets                         |
    +-------------------------+---------------+------------------+---+
    |  subnet-0abc123...      | 10.0.0.0/20   | ap-northeast-1a  | Subnet-AZ-A |
    |  subnet-0def456...      | 10.0.16.0/20  | ap-northeast-1c  | Subnet-AZ-C |
    +-------------------------+---------------+------------------+---+
```



1. æ‰¿ç¬¬ä¸€é¡Œï¼Œç‚ºè©²å…©å€‹ subnet åˆ†åˆ¥å‰µå»ºä¸€å€‹ route tableï¼Œä½¿å…¶æˆç‚º public è·Ÿ private subnetã€‚
```
  â˜… Insight â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  Public vs Private çš„é—œéµå·®ç•°ï¼š
  - Public Subnetï¼šRoute Table æœ‰ 0.0.0.0/0 â†’ IGW çš„è·¯ç”±
  - Private Subnetï¼šRoute Table æ²’æœ‰ ç›´æ¥åˆ° IGW çš„è·¯ç”±
  - Subnet æœ¬èº«æ²’æœ‰ public/private å±¬æ€§ï¼Œå®Œå…¨ç”± Route Table æ±ºå®šï¼
  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
```
  æ¶æ§‹ç›®æ¨™

                      Internet
                          â”‚
                          â–¼
                  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                  â”‚ Internet GW   â”‚
                  â””â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜
                          â”‚
          â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
          â”‚               â”‚               â”‚
          â”‚         VPC (10.0.0.0/18)     â”‚
          â”‚               â”‚               â”‚
          â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
          â”‚   â”‚  Public Route Table   â”‚   â”‚
          â”‚   â”‚  0.0.0.0/0 â†’ IGW      â”‚   â”‚
          â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
          â”‚               â”‚               â”‚
          â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
          â”‚   â”‚  Public Subnet (1a)   â”‚   â”‚
          â”‚   â”‚    10.0.0.0/20        â”‚   â”‚
          â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
          â”‚                               â”‚
          â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
          â”‚   â”‚  Private Route Table  â”‚   â”‚
          â”‚   â”‚  (local only)         â”‚   â”‚
          â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
          â”‚               â”‚               â”‚
          â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
          â”‚   â”‚  Private Subnet (1c)  â”‚   â”‚
          â”‚   â”‚    10.0.16.0/20       â”‚   â”‚
          â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
          â”‚                               â”‚
          â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

  ---
  å‰ç½®ï¼šè¨­å®šè®Šæ•¸

  å¦‚æœä½ é‚„æœ‰ä¹‹å‰çš„è®Šæ•¸å°±è·³éï¼Œå¦å‰‡å…ˆæŸ¥è©¢ï¼š
```
  REGION="ap-northeast-1"

  - å–å¾— VPC ID
  VPC_ID=$(aws ec2 describe-vpcs \
    --region $REGION \
    --filters "Name=tag:Name,Values=MyTokyoVPC" \
    --query 'Vpcs[0].VpcId' --output text)
  echo "VPC: $VPC_ID"

  # å–å¾— Subnet IDs
  SUBNET_A=$(aws ec2 describe-subnets \
    --region $REGION \
    --filters "Name=vpc-id,Values=$VPC_ID" "Name=availability-zone,Values=${REGION}a" \
    --query 'Subnets[0].SubnetId' --output text)
  echo "Subnet A (will be public): $SUBNET_A"

  SUBNET_C=$(aws ec2 describe-subnets \
    --region $REGION \
    --filters "Name=vpc-id,Values=$VPC_ID" "Name=availability-zone,Values=${REGION}c" \
    --query 'Subnets[0].SubnetId' --output text)
  echo "Subnet C (will be private): $SUBNET_C"
```
  ---
  æ­¥é©Ÿä¸€ï¼šå»ºç«‹ Internet Gateway
```
  - å»ºç«‹ IGW
  IGW_ID=$(aws ec2 create-internet-gateway \
    --region $REGION \
    --query 'InternetGateway.InternetGatewayId' --output text)
  echo "Created IGW: $IGW_ID"

  - åŠ ä¸Š Name tag
  aws ec2 create-tags \
    --resources $IGW_ID \
    --tags Key=Name,Value=MyTokyoVPC-IGW \
    --region $REGION

  - é™„åŠ åˆ° VPC
  aws ec2 attach-internet-gateway \
    --internet-gateway-id $IGW_ID \
    --vpc-id $VPC_ID \
    --region $REGION
  echo "Attached IGW to VPC"
```
  ---
  æ­¥é©ŸäºŒï¼šå»ºç«‹ Public Route Table
```
  - å»ºç«‹ Route Table
  PUBLIC_RT=$(aws ec2 create-route-table \
    --vpc-id $VPC_ID \
    --region $REGION \
    --query 'RouteTable.RouteTableId' --output text)
  echo "Created Public Route Table: $PUBLIC_RT"

  - åŠ ä¸Š Name tag
  aws ec2 create-tags \
    --resources $PUBLIC_RT \
    --tags Key=Name,Value=Public-RT \
    --region $REGION

  - æ–°å¢è·¯ç”±ï¼šæ‰€æœ‰å¤–éƒ¨æµé‡ â†’ IGW
  aws ec2 create-route \
    --route-table-id $PUBLIC_RT \
    --destination-cidr-block 0.0.0.0/0 \
    --gateway-id $IGW_ID \
    --region $REGION
  echo "Added route 0.0.0.0/0 â†’ IGW"

  - é—œè¯åˆ° Public Subnet (Subnet A)
  aws ec2 associate-route-table \
    --route-table-id $PUBLIC_RT \
    --subnet-id $SUBNET_A \
    --region $REGION
  echo "Associated Public RT with Subnet A"
```
  ---
  æ­¥é©Ÿä¸‰ï¼šå»ºç«‹ Private Route Table
```
  - å»ºç«‹ Route Table
  PRIVATE_RT=$(aws ec2 create-route-table \
    --vpc-id $VPC_ID \
    --region $REGION \
    --query 'RouteTable.RouteTableId' --output text)
  echo "Created Private Route Table: $PRIVATE_RT"

  - åŠ ä¸Š Name tag
  aws ec2 create-tags \
    --resources $PRIVATE_RT \
    --tags Key=Name,Value=Private-RT \
    --region $REGION

  - Private RT ä¸éœ€è¦æ–°å¢ä»»ä½•è·¯ç”±ï¼ˆåªä¿ç•™ localï¼‰

  - é—œè¯åˆ° Private Subnet (Subnet C)
  aws ec2 associate-route-table \
    --route-table-id $PRIVATE_RT \
    --subnet-id $SUBNET_C \
    --region $REGION
  echo "Associated Private RT with Subnet C"
```
  ---
  æ­¥é©Ÿå››ï¼šé©—è­‰
```
  - æŸ¥çœ‹ Route Tables
  aws ec2 describe-route-tables \
    --filters "Name=vpc-id,Values=$VPC_ID" \
    --region $REGION \
    --query 'RouteTables[*].[RouteTableId,Tags[?Key==`Name`].Value|[0],Routes[*].[DestinationCidrBlock,GatewayId]]' \
    --output text
```
    é æœŸçµæœï¼š
    rtb-xxx  Public-RT
        10.0.0.0/18    local
        0.0.0.0/0      igw-xxx    â† é€™æ˜¯ Public çš„é—œéµï¼

    rtb-yyy  Private-RT
        10.0.0.0/18    local      â† åªæœ‰ localï¼Œæ²’æœ‰ IGW

  ---
  æ­¥é©Ÿäº”ï¼šï¼ˆé¸ç”¨ï¼‰å•Ÿç”¨ Public IP è‡ªå‹•åˆ†é…

  è®“ Public Subnet ä¸­å•Ÿå‹•çš„ EC2 è‡ªå‹•å–å¾— Public IPï¼š
```
  aws ec2 modify-subnet-attribute \
    --subnet-id $SUBNET_A \
    --map-public-ip-on-launch \
    --region $REGION
  echo "Enabled auto-assign public IP for Subnet A"
```
3. æ‰¿ç¬¬äºŒé¡Œï¼Œåœ¨å…©å€‹ subnet ä¸Šåˆ†åˆ¥å‰µå»ºä¸€å° ec2ï¼Œä¸¦ä¸”ä½¿ç”¨ ssh å¾è‡ªå·±çš„ laptop é€£ä¸Šæ­¤å…©å° ec2ï¼Œæä¾›ä½ çš„åšæ³•ã€‚

    â˜… Insight â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    æŒ‘æˆ°é»ï¼š
    - Public Subnet EC2ï¼šæœ‰ Public IPï¼Œå¯ç›´æ¥ SSH
    - Private Subnet EC2ï¼šæ²’æœ‰ Public IPï¼Œç„¡æ³•ç›´æ¥å¾ Internet é€£ç·š

    è§£æ±ºæ–¹æ¡ˆï¼šä½¿ç”¨ Bastion Hostï¼ˆè·³æ¿æ©Ÿï¼‰
    å…ˆ SSH åˆ° Public EC2ï¼Œå†å¾é‚£è£¡è·³åˆ° Private EC2
    â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

  ---

  æ¶æ§‹åœ–
```
  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
  â”‚   Laptop     â”‚        â”‚              VPC                        â”‚
  â”‚              â”‚        â”‚                                         â”‚
  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚   SSH  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
  â”‚  â”‚Terminalâ”‚â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â–ºâ”‚ Public Subnet (10.0.0.0/20)     â”‚   â”‚
  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚   :22  â”‚  â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”      â”‚   â”‚
  â”‚              â”‚        â”‚  â”‚   â”‚ EC2 (Bastion)        â”‚      â”‚   â”‚
  â”‚              â”‚        â”‚  â”‚   â”‚ Public IP: x.x.x.x   â”‚      â”‚   â”‚
  â”‚              â”‚        â”‚  â”‚   â”‚ Private IP: 10.0.x.x â”‚      â”‚   â”‚
  â”‚              â”‚        â”‚  â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜      â”‚   â”‚
  â”‚              â”‚        â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
  â”‚              â”‚        â”‚                 â”‚ SSH :22              â”‚
  â”‚              â”‚        â”‚                 â–¼                      â”‚
  â”‚              â”‚        â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
  â”‚              â”‚        â”‚  â”‚ Private Subnet (10.0.16.0/20)   â”‚   â”‚
  â”‚              â”‚        â”‚  â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”      â”‚   â”‚
  â”‚              â”‚        â”‚  â”‚   â”‚ EC2 (Private)        â”‚      â”‚   â”‚
  â”‚              â”‚        â”‚  â”‚   â”‚ Private IP: 10.0.16.xâ”‚      â”‚   â”‚
  â”‚              â”‚        â”‚  â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜      â”‚   â”‚
  â”‚              â”‚        â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```
  ---
  æ­¥é©Ÿä¸€ï¼šå»ºç«‹ Security Group

  1.1 Bastion Host çš„ Security Groupï¼ˆå…è¨±å¾ Internet SSHï¼‰

  REGION="ap-northeast-1"
```
  - å–å¾— VPC ID
  VPC_ID=$(aws ec2 describe-vpcs \
    --region $REGION \
    --filters "Name=tag:Name,Values=MyTokyoVPC" \
    --query 'Vpcs[0].VpcId' --output text)

  - å»ºç«‹ Bastion SG
  BASTION_SG=$(aws ec2 create-security-group \
    --group-name Bastion-SG \
    --description "Allow SSH from Internet" \
    --vpc-id $VPC_ID \
    --region $REGION \
    --query 'GroupId' --output text)
  echo "Bastion SG: $BASTION_SG"

  - å…è¨±å¾ä»»ä½•åœ°æ–¹ SSHï¼ˆå»ºè­°æ”¹æˆä½ çš„ IPï¼‰
  aws ec2 authorize-security-group-ingress \
    --group-id $BASTION_SG \
    --protocol tcp \
    --port 22 \
    --cidr 0.0.0.0/0 \
    --region $REGION
```
  âš ï¸ å®‰å…¨å»ºè­°ï¼šå°‡ 0.0.0.0/0 æ”¹æˆä½ çš„ IPï¼Œä¾‹å¦‚ 1.2.3.4/32
  æŸ¥è©¢ä½ çš„ IPï¼šcurl ifconfig.me

  1.2 Private EC2 çš„ Security Groupï¼ˆåªå…è¨±å¾ Bastion SSHï¼‰

  PRIVATE_SG=$(aws ec2 create-security-group \
    --group-name Private-SG \
    --description "Allow SSH from Bastion only" \
    --vpc-id $VPC_ID \
    --region $REGION \
    --query 'GroupId' --output text)
  echo "Private SG: $PRIVATE_SG"

  - åªå…è¨±å¾ Bastion SG ä¾†çš„ SSH
  aws ec2 authorize-security-group-ingress \
    --group-id $PRIVATE_SG \
    --protocol tcp \
    --port 22 \
    --source-group $BASTION_SG \
    --region $REGION

  ---
  æ­¥é©ŸäºŒï¼šå»ºç«‹ Key Pairï¼ˆå¦‚æœé‚„æ²’æœ‰ï¼‰
```
  aws ec2 create-key-pair \
    --key-name tokyo-vpc-key \
    --region $REGION \
    --query 'KeyMaterial' \
    --output text > ~/.ssh/tokyo-vpc-key.pem
```
```
  chmod 400 ~/.ssh/tokyo-vpc-key.pem
  echo "Key saved to ~/.ssh/tokyo-vpc-key.pem"
```
  ---
  æ­¥é©Ÿä¸‰ï¼šå•Ÿå‹• EC2

  3.1 å–å¾— Amazon Linux 2023 AMI ID
```
  AMI_ID=$(aws ec2 describe-images \
    --owners amazon \
    --filters "Name=name,Values=al2023-ami-*-x86_64" \
    --query 'sort_by(Images, &CreationDate)[-1].ImageId' \
    --region $REGION \
    --output text)
  echo "AMI: $AMI_ID"
```
  3.2 å–å¾— Subnet IDs
```
  SUBNET_PUBLIC=$(aws ec2 describe-subnets \
    --region $REGION \
    --filters "Name=vpc-id,Values=$VPC_ID" "Name=tag:Name,Values=Subnet-AZ-A" \
    --query 'Subnets[0].SubnetId' --output text)
  echo "Public Subnet: $SUBNET_PUBLIC"
```
```
  SUBNET_PRIVATE=$(aws ec2 describe-subnets \
    --region $REGION \
    --filters "Name=vpc-id,Values=$VPC_ID" "Name=tag:Name,Values=Subnet-AZ-C" \
    --query 'Subnets[0].SubnetId' --output text)
  echo "Private Subnet: $SUBNET_PRIVATE"
```
  3.3 å•Ÿå‹• Bastion Hostï¼ˆPublic Subnetï¼‰
```
  BASTION_ID=$(aws ec2 run-instances \
    --image-id $AMI_ID \
    --instance-type t2.micro \
    --key-name tokyo-vpc-key \
    --subnet-id $SUBNET_PUBLIC \
    --security-group-ids $BASTION_SG \
    --associate-public-ip-address \
    --tag-specifications 'ResourceType=instance,Tags=[{Key=Name,Value=Bastion-Host}]' \
    --region $REGION \
    --query 'Instances[0].InstanceId' --output text)
  echo "Bastion Host: $BASTION_ID"
```
  3.4 å•Ÿå‹• Private EC2ï¼ˆPrivate Subnetï¼‰
```
  PRIVATE_ID=$(aws ec2 run-instances \
    --image-id $AMI_ID \
    --instance-type t2.micro \
    --key-name tokyo-vpc-key \
    --subnet-id $SUBNET_PRIVATE \
    --security-group-ids $PRIVATE_SG \
    --tag-specifications 'ResourceType=instance,Tags=[{Key=Name,Value=Private-EC2}]' \
    --region $REGION \
    --query 'Instances[0].InstanceId' --output text)
  echo "Private EC2: $PRIVATE_ID"
```
  ---
  æ­¥é©Ÿå››ï¼šå–å¾— IP åœ°å€

  ç­‰å¾…ç´„ 30 ç§’è®“ EC2 å•Ÿå‹•å®Œæˆï¼š

  - Bastion çš„ Public IP
  ```
  BASTION_IP=$(aws ec2 describe-instances \
    --instance-ids $BASTION_ID \
    --region $REGION \
    --query 'Reservations[0].Instances[0].PublicIpAddress' --output text)
  echo "Bastion Public IP: $BASTION_IP"
```
  - Private EC2 çš„ Private IP
  ```
  PRIVATE_IP=$(aws ec2 describe-instances \
    --instance-ids $PRIVATE_ID \
    --region $REGION \
    --query 'Reservations[0].Instances[0].PrivateIpAddress' --output text)
  echo "Private EC2 Private IP: $PRIVATE_IP"
```
  ---
  æ­¥é©Ÿäº”ï¼šSSH é€£ç·š

  5.1 é€£ç·šåˆ° Bastion Hostï¼ˆç›´æ¥é€£ï¼‰

  ssh -i ~/.ssh/tokyo-vpc-key.pem ec2-user@$BASTION_IP

  5.2 é€£ç·šåˆ° Private EC2ï¼ˆé€é Bastion è·³è½‰ï¼‰

  æ–¹æ³• Aï¼šå…©æ­¥é©Ÿè·³è½‰
```
  - 1. å…ˆé€£åˆ° Bastion
  ssh -i ~/.ssh/tokyo-vpc-key.pem ec2-user@$BASTION_IP

  - 2. åœ¨ Bastion ä¸Šï¼Œå†é€£åˆ° Private EC2ï¼ˆéœ€è¦å…ˆæŠŠ key è¤‡è£½åˆ° Bastionï¼‰
  ssh -i ~/tokyo-vpc-key.pem ec2-user@10.0.16.x
```
  æ–¹æ³• Bï¼šä½¿ç”¨ SSH ProxyJumpï¼ˆæ¨è–¦ï¼ï¼‰
```
  # ä¸€è¡ŒæŒ‡ä»¤ç›´æ¥è·³è½‰
  ssh -i ~/.ssh/tokyo-vpc-key.pem \
    -o ProxyCommand="ssh -i ~/.ssh/tokyo-vpc-key.pem -W %h:%p ec2-user@$BASTION_IP" \
    ec2-user@$PRIVATE_IP
```
  æ–¹æ³• Cï¼šè¨­å®š SSH Configï¼ˆæœ€æ–¹ä¾¿ï¼‰

  ç·¨è¼¯ ~/.ssh/configï¼š
```
  cat << EOF >> ~/.ssh/config

  Host bastion-tokyo
    HostName $BASTION_IP
    User ec2-user
    IdentityFile ~/.ssh/tokyo-vpc-key.pem

  Host private-ec2-tokyo
    HostName $PRIVATE_IP
    User ec2-user
    IdentityFile ~/.ssh/tokyo-vpc-key.pem
    ProxyJump bastion-tokyo
  EOF
```
  ä¹‹å¾Œåªéœ€è¦ï¼š
```
  # é€£ Bastion
  ssh bastion-tokyo

  # é€£ Private EC2ï¼ˆè‡ªå‹•é€é Bastion è·³è½‰ï¼‰
  ssh private-ec2-tokyo
```
  ---
  é©—è­‰é€£ç·š
```
  # åœ¨å„å° EC2 ä¸ŠåŸ·è¡Œï¼Œç¢ºèªèº«ä»½
  curl -s http://169.254.169.254/latest/meta-data/instance-id
  curl -s http://169.254.169.254/latest/meta-data/local-ipv4
```
  ---
  â˜… Insight â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  Bastion Host å®‰å…¨æœ€ä½³å¯¦è¸ï¼š
  1. é™åˆ¶ä¾†æº IPï¼šSecurity Group åªå…è¨±ç‰¹å®š IP
  2. ä½¿ç”¨ Session Managerï¼šå¯å®Œå…¨ä¸é–‹ 22 port
  3. å•Ÿç”¨ MFAï¼šæ­é… IAM é€²è¡Œé›™é‡é©—è­‰
  4. è¨˜éŒ„ç¨½æ ¸æ—¥èªŒï¼šä½¿ç”¨ CloudTrail è¨˜éŒ„å­˜å–

  æ›´ç¾ä»£çš„æ›¿ä»£æ–¹æ¡ˆï¼š
  - AWS Systems Manager Session Managerï¼šä¸éœ€è¦é–‹æ”¾ä»»ä½• port
  - EC2 Instance Connect Endpointï¼šç„¡éœ€ Public IP å³å¯é€£ç·š
  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€



3. åœ¨ public ec2 ä¸Šå®‰è£ nginxï¼Œä¸¦ä¸”ä½¿ç”¨ç€è¦½å™¨è¼¸å…¥ public ipï¼Œå–å¾— nginx çš„ç¶²é é é¢å¾Œæˆªåœ–ã€‚
    â˜… Insight â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  éœ€è¦å…©å€‹æ¢ä»¶æ‰èƒ½å¾ç€è¦½å™¨å­˜å–ï¼š
  1. ç¶²è·¯å±¤ï¼šRoute Table æœ‰è·¯ç”±åˆ° IGWï¼ˆå·²å®Œæˆ âœ…ï¼‰
  2. Security Groupï¼šå¿…é ˆé–‹æ”¾ HTTP port 80
  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

  ---
  æ­¥é©Ÿä¸€ï¼šé–‹æ”¾ Security Group çš„ HTTP Port
```
  REGION="ap-northeast-1"

  - å–å¾— Bastion SG ID
  BASTION_SG=$(aws ec2 describe-security-groups \
    --region $REGION \
    --filters "Name=group-name,Values=Bastion-SG" \
    --query 'SecurityGroups[0].GroupId' --output text)

  - æ–°å¢ HTTP (port 80) è¦å‰‡
  aws ec2 authorize-security-group-ingress \
    --group-id $BASTION_SG \
    --protocol tcp \
    --port 80 \
    --cidr 0.0.0.0/0 \
    --region $REGION

  echo "å·²é–‹æ”¾ port 80"
```
  ---
  æ­¥é©ŸäºŒï¼šSSH é€²å…¥ Public EC2 ä¸¦å®‰è£ Nginx

  - SSH é€²å…¥ Bastion Host
  ssh -i ~/.ssh/tokyo-vpc-key.pem ec2-user@<BASTION_PUBLIC_IP>

  åœ¨ EC2 å…§åŸ·è¡Œï¼š

  - æ›´æ–°å¥—ä»¶
  sudo dnf update -y

  - å®‰è£ nginx
  sudo dnf install nginx -y

  - å•Ÿå‹• nginx
  sudo systemctl start nginx

  - è¨­å®šé–‹æ©Ÿè‡ªå‹•å•Ÿå‹•
  sudo systemctl enable nginx

  - ç¢ºèª nginx ç‹€æ…‹
  sudo systemctl status nginx

  ---
  æ­¥é©Ÿä¸‰ï¼šæ¸¬è©¦

  åœ¨ EC2 å…§æœ¬æ©Ÿæ¸¬è©¦ï¼š

  curl localhost

  æ‡‰è©²æœƒçœ‹åˆ° HTML å…§å®¹ã€‚

  å¾ç€è¦½å™¨æ¸¬è©¦ï¼š

  æ‰“é–‹ç€è¦½å™¨ï¼Œè¼¸å…¥ï¼š

  http://<BASTION_PUBLIC_IP>

  æ‡‰è©²æœƒçœ‹åˆ° Nginx æ­¡è¿é é¢ï¼
  ![alt text](image.png)

4. å˜—è©¦åœ¨ private çš„é‚£å° ec2 ä¸Šä½¿ç”¨ curl google.com æŒ‡ä»¤ï¼Œå–å¾—å›å‚³çš„ html é é¢ï¼ˆæœ‰å›å‚³å°±æ˜¯æˆåŠŸï¼‰=> å¦‚ä½•åšåˆ°ï¼Ÿ=> ä½¿ç”¨ nat gateway
- ç‰¹åˆ¥è­¦å‘Šï¼šNAT Gateway è²»ç”¨è¼ƒé«˜ï¼Œå¦‚æœæœ‰å‰µå»ºï¼Œè¦è¨˜å¾—åˆªé™¤ä¹¾æ·¨ã€‚
âº å¯¦ä½œï¼šä½¿ç”¨ NAT Gateway è®“ Private EC2 å­˜å– Internet

  â˜… Insight â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  NAT Gateway çš„ä½œç”¨ï¼š
  - è®“ Private Subnet çš„è³‡æºå¯ä»¥ã€Œå‡ºå»ã€å­˜å– Internet
  - ä½† Internet ç„¡æ³•ä¸»å‹•ã€Œé€²ä¾†ã€é€£ç·š Private è³‡æº
  - é¡ä¼¼å®¶ç”¨è·¯ç”±å™¨çš„ NAT åŠŸèƒ½

  ä½¿ç”¨å ´æ™¯ï¼š ä¸‹è¼‰å¥—ä»¶æ›´æ–°ã€å‘¼å«å¤–éƒ¨ APIã€å­˜å– AWS æœå‹™
  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

  ---
  æ¶æ§‹åœ–

                          Internet
                              â”‚
                              â–¼
                      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                      â”‚      IGW      â”‚
                      â””â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜
                              â”‚
          â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
          â”‚                   â”‚      VPC          â”‚
          â”‚                   â”‚                   â”‚
          â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
          â”‚   â”‚   Public Subnet (10.0.0.0/20)  â”‚  â”‚
          â”‚   â”‚                                â”‚  â”‚
          â”‚   â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚  â”‚
          â”‚   â”‚  â”‚ Bastion  â”‚   â”‚    NAT    â”‚  â”‚  â”‚
          â”‚   â”‚  â”‚   Host   â”‚   â”‚  Gateway  â”‚  â”‚  â”‚
          â”‚   â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â””â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜  â”‚  â”‚
          â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
          â”‚                           â”‚           â”‚
          â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
          â”‚   â”‚  Private Subnet (10.0.16.0/20) â”‚  â”‚
          â”‚   â”‚                                â”‚  â”‚
          â”‚   â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                  â”‚  â”‚
          â”‚   â”‚  â”‚ Private  â”‚ curl google.com  â”‚  â”‚
          â”‚   â”‚  â”‚   EC2    â”‚ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–ºâ”‚  â”‚
          â”‚   â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜      ç¶“ç”± NAT GW â”‚  â”‚
          â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
          â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

  ---
  æ­¥é©Ÿä¸€ï¼šå»ºç«‹ Elastic IP
```
  NAT Gateway éœ€è¦ä¸€å€‹å›ºå®šçš„ Public IPï¼š

  REGION="ap-northeast-1"

  # é…ç½® Elastic IP
  EIP_ALLOC=$(aws ec2 allocate-address \
    --domain vpc \
    --region $REGION \
    --query 'AllocationId' --output text)
  echo "Elastic IP Allocation ID: $EIP_ALLOC"

  # æŸ¥çœ‹åˆ†é…åˆ°çš„ IP
  aws ec2 describe-addresses \
    --allocation-ids $EIP_ALLOC \
    --region $REGION \
    --query 'Addresses[0].PublicIp' --output text
```
  ---
  æ­¥é©ŸäºŒï¼šå»ºç«‹ NAT Gateway
  NAT Gateway å¿…é ˆæ”¾åœ¨ Public Subnetï¼š
```
  # å–å¾— VPC å’Œ Public Subnet ID
  VPC_ID=$(aws ec2 describe-vpcs \
    --region $REGION \
    --filters "Name=tag:Name,Values=MyTokyoVPC" \
    --query 'Vpcs[0].VpcId' --output text)

  SUBNET_PUBLIC=$(aws ec2 describe-subnets \
    --region $REGION \
    --filters "Name=vpc-id,Values=$VPC_ID" "Name=tag:Name,Values=Subnet-AZ-A" \
    --query 'Subnets[0].SubnetId' --output text)

  # å»ºç«‹ NAT Gateway
  NAT_GW=$(aws ec2 create-nat-gateway \
    --subnet-id $SUBNET_PUBLIC \
    --allocation-id $EIP_ALLOC \
    --region $REGION \
    --query 'NatGateway.NatGatewayId' --output text)
  echo "NAT Gateway: $NAT_GW"

  # åŠ ä¸Š Name tag
  aws ec2 create-tags \
    --resources $NAT_GW \
    --tags Key=Name,Value=MyTokyoVPC-NAT \
    --region $REGION
```
  ---
  æ­¥é©Ÿä¸‰ï¼šç­‰å¾… NAT Gateway å•Ÿå‹•

  NAT Gateway éœ€è¦ç´„ 1-2 åˆ†é˜æ‰æœƒè®Šæˆ availableï¼š
```
  # æŸ¥çœ‹ç‹€æ…‹
  aws ec2 describe-nat-gateways \
    --nat-gateway-ids $NAT_GW \
    --region $REGION \
    --query 'NatGateways[0].State' --output text

  # æˆ–ç­‰å¾…ç›´åˆ° available
  echo "ç­‰å¾… NAT Gateway å•Ÿå‹•..."
  aws ec2 wait nat-gateway-available \
    --nat-gateway-ids $NAT_GW \
    --region $REGION
  echo "NAT Gateway å·²å°±ç·’ï¼"
```
  ---
  æ­¥é©Ÿå››ï¼šæ›´æ–° Private Route Table

  å°‡ 0.0.0.0/0 æµé‡å°å‘ NAT Gatewayï¼š
```
  # å–å¾— Private Route Table ID
  PRIVATE_RT=$(aws ec2 describe-route-tables \
    --region $REGION \
    --filters "Name=vpc-id,Values=$VPC_ID" "Name=tag:Name,Values=Private-RT" \
    --query 'RouteTables[0].RouteTableId' --output text)
  echo "Private Route Table: $PRIVATE_RT"
```
  - æ–°å¢è·¯ç”±ï¼šæ‰€æœ‰å¤–éƒ¨æµé‡ â†’ NAT Gateway
  ```
  aws ec2 create-route \
    --route-table-id $PRIVATE_RT \
    --destination-cidr-block 0.0.0.0/0 \
    --nat-gateway-id $NAT_GW \
    --region $REGION
  echo "å·²æ–°å¢è·¯ç”± 0.0.0.0/0 â†’ NAT Gateway"
```
  ---
  æ­¥é©Ÿäº”ï¼šé©—è­‰

  ç¢ºèª Route Table è¨­å®šï¼š

  aws ec2 describe-route-tables \
    --route-table-ids $PRIVATE_RT \
    --region $REGION \
    --query 'RouteTables[0].Routes' --output table

  æ‡‰è©²çœ‹åˆ°ï¼š
  |  DestinationCidrBlock  |  NatGatewayId       |  GatewayId  |
  |------------------------|---------------------|-------------|
  |  10.0.0.0/18           |                     |  local      |
  |  0.0.0.0/0             |  nat-0xxxxx         |             |  â† æ–°å¢çš„ï¼

  ---
  æ­¥é©Ÿå…­ï¼šæ¸¬è©¦ï¼ğŸ§ª

  SSH é€²å…¥ Private EC2ï¼ˆé€é Bastionï¼‰ï¼š

  - ä½¿ç”¨ä¹‹å‰è¨­å®šçš„ SSH config
  ssh private-ec2-tokyo

  - æˆ–ä½¿ç”¨ ProxyJump
  ssh -i ~/.ssh/tokyo-vpc-key.pem \
    -o ProxyCommand="ssh -i ~/.ssh/tokyo-vpc-key.pem -W %h:%p ec2-user@<BASTION_IP>" \
    ec2-user@<PRIVATE_EC2_IP>

  åœ¨ Private EC2 å…§åŸ·è¡Œï¼š

  - æ¸¬è©¦ Internet é€£ç·š
  curl -I https://google.com

  - æˆ–å–å¾—å®Œæ•´é é¢
  curl https://google.com

  æˆåŠŸçš„è©±æœƒçœ‹åˆ°ï¼š

  HTTP/2 200
  content-type: text/html; charset=ISO-8859-1
  ...

  ---
  å®Œæ•´æ¸¬è©¦è…³æœ¬ï¼ˆåœ¨ Private EC2 å…§ï¼‰

  echo "=== æ¸¬è©¦ DNS è§£æ ==="
  nslookup google.com

  echo ""
  echo "=== æ¸¬è©¦ HTTP é€£ç·š ==="
  curl -s -o /dev/null -w "HTTP Status: %{http_code}\n" https://google.com

  echo ""
  echo "=== å–å¾—å¤–éƒ¨ IPï¼ˆæ‡‰è©²æ˜¯ NAT Gateway çš„ EIPï¼‰==="
  curl -s ifconfig.me

  æœ€å¾Œä¸€å€‹æŒ‡ä»¤æœƒé¡¯ç¤ºä½ é…ç½®çš„ Elastic IPï¼Œè­‰æ˜æµé‡ç¢ºå¯¦ç¶“é NAT Gatewayï¼

  ---
  â˜… Insight â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  NAT Gateway é‡é»ï¼š

  | é …ç›®       | èªªæ˜                             |
  |------------|----------------------------------|
  | ä½ç½®       | å¿…é ˆåœ¨ Public Subnet             |
  | Elastic IP | å¿…é ˆé…ç½®ï¼ˆæ¯æœˆç´„ $3.5 + æµé‡è²»ï¼‰ |
  | é«˜å¯ç”¨     | å–®ä¸€ AZï¼Œå»ºè­°æ¯å€‹ AZ å„å»ºä¸€å€‹    |
  | è²»ç”¨       | ç´„ $0.045/hr + $0.045/GBï¼ˆæ±äº¬ï¼‰ |

  èˆ‡ NAT Instance æ¯”è¼ƒï¼š
  - NAT Gatewayï¼šAWS ç®¡ç†ï¼Œé«˜å¯ç”¨ï¼Œä½†è¼ƒè²´
  - NAT Instanceï¼šè‡ªå·±ç®¡ç†çš„ EC2ï¼Œä¾¿å®œä½†éœ€ç¶­è­·

  çœéŒ¢æŠ€å·§ï¼š é–‹ç™¼ç’°å¢ƒå¯ä»¥ä¸ç”¨ NAT Gatewayï¼Œæ”¹ç”¨ VPC Endpoint å­˜å– AWS æœå‹™
  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

  ---
  æ¸…ç†ï¼ˆæ¸¬è©¦å®Œæˆå¾Œï¼‰
```
  NAT Gateway æœƒæŒçºŒç”¢ç”Ÿè²»ç”¨ï¼Œä¸éœ€è¦æ™‚è¨˜å¾—åˆªé™¤ï¼š

  - åˆªé™¤ NAT Gateway
  aws ec2 delete-nat-gateway \
    --nat-gateway-id $NAT_GW \
    --region $REGION

  - ç­‰å¾…åˆªé™¤å®Œæˆå¾Œï¼Œé‡‹æ”¾ Elastic IP
  aws ec2 release-address \
    --allocation-id $EIP_ALLOC \
    --region $REGION

  - ç§»é™¤ Private Route Table çš„è·¯ç”±
  aws ec2 delete-route \
    --route-table-id $PRIVATE_RT \
    --destination-cidr-block 0.0.0.0/0 \
    --region $REGION
```


  è¨­å®šè®Šæ•¸

  REGION="ap-northeast-1"

  VPC_ID=$(aws ec2 describe-vpcs \
    --region $REGION \
    --filters "Name=tag:Name,Values=MyTokyoVPC" \
    --query 'Vpcs[0].VpcId' --output text)
  echo "VPC: $VPC_ID"

  ---
  1ï¸âƒ£ çµ‚æ­¢ EC2 Instances
```
  # åˆ—å‡º VPC å…§æ‰€æœ‰ EC2
  INSTANCE_IDS=$(aws ec2 describe-instances \
    --region $REGION \
    --filters "Name=vpc-id,Values=$VPC_ID" "Name=instance-state-name,Values=running,stopped" \
    --query 'Reservations[*].Instances[*].InstanceId' --output text)
  echo "EC2 Instances: $INSTANCE_IDS"

  # çµ‚æ­¢æ‰€æœ‰ EC2
    INSTANCE_IDS=$(aws ec2 describe-instances \
    --region $REGION \
    --filters "Name=vpc-id,Values=$VPC_ID" "Name=instance-state-name,Values=running,stopped" \
    --query 'Reservations[*].Instances[*].InstanceId' --output text | tr '\n' ' ')

  echo "EC2 Instances: $INSTANCE_IDS"
    aws ec2 terminate-instances \
    --instance-ids $INSTANCE_IDS \
    --region $REGION

```
  ---
  2ï¸âƒ£ åˆªé™¤ NAT Gateway
```
  # å–å¾— NAT Gateway ID
  NAT_GW=$(aws ec2 describe-nat-gateways \
    --region $REGION \
    --filter "Name=vpc-id,Values=$VPC_ID" "Name=state,Values=available" \
    --query 'NatGateways[0].NatGatewayId' --output text)

  if [ "$NAT_GW" != "None" ] && [ -n "$NAT_GW" ]; then
    echo "åˆªé™¤ NAT Gateway: $NAT_GW"
    aws ec2 delete-nat-gateway \
      --nat-gateway-id $NAT_GW \
      --region $REGION

    echo "ç­‰å¾… NAT Gateway åˆªé™¤ï¼ˆç´„ 1-2 åˆ†é˜ï¼‰..."
    while true; do
      STATE=$(aws ec2 describe-nat-gateways \
        --nat-gateway-ids $NAT_GW \
        --region $REGION \
        --query 'NatGateways[0].State' --output text)
      echo "ç‹€æ…‹: $STATE"
      if [ "$STATE" == "deleted" ]; then break; fi
      sleep 10
    done
    echo "NAT Gateway å·²åˆªé™¤"
  fi
```
  ---
  3ï¸âƒ£ é‡‹æ”¾ Elastic IP
```
  # å–å¾—æœªé—œè¯çš„ Elastic IP
  EIP_ALLOCS=$(aws ec2 describe-addresses \
    --region $REGION \
    --filters "Name=domain,Values=vpc" \
    --query 'Addresses[?AssociationId==`null`].AllocationId' --output text)

  for EIP in $EIP_ALLOCS; do
    echo "é‡‹æ”¾ Elastic IP: $EIP"
    aws ec2 release-address \
      --allocation-id $EIP \
      --region $REGION
  done
```
  ---
  4ï¸âƒ£ åˆªé™¤ Internet Gateway
```
  # å–å¾— IGW ID
  IGW_ID=$(aws ec2 describe-internet-gateways \
    --region $REGION \
    --filters "Name=attachment.vpc-id,Values=$VPC_ID" \
    --query 'InternetGateways[0].InternetGatewayId' --output text)

  if [ "$IGW_ID" != "None" ] && [ -n "$IGW_ID" ]; then
    echo "åˆ†é›¢ä¸¦åˆªé™¤ IGW: $IGW_ID"
    # å…ˆåˆ†é›¢
    aws ec2 detach-internet-gateway \
      --internet-gateway-id $IGW_ID \
      --vpc-id $VPC_ID \
      --region $REGION
     å†åˆªé™¤
    aws ec2 delete-internet-gateway \
      --internet-gateway-id $IGW_ID \
      --region $REGION
    echo "IGW å·²åˆªé™¤"
  fi
```
  ---
  5ï¸âƒ£ åˆªé™¤ Subnets

  - å–å¾—æ‰€æœ‰ Subnet
  ```
  SUBNET_IDS=$(aws ec2 describe-subnets \
    --region $REGION \
    --filters "Name=vpc-id,Values=$VPC_ID" \
    --query 'Subnets[*].SubnetId' --output text)

  for SUBNET in $SUBNET_IDS; do
    echo "åˆªé™¤ Subnet: $SUBNET"
    aws ec2 delete-subnet \
      --subnet-id $SUBNET \
      --region $REGION
  done
  echo "æ‰€æœ‰ Subnet å·²åˆªé™¤"
  ```

  ---
  6ï¸âƒ£ åˆªé™¤ Route Tablesï¼ˆä¿ç•™ Mainï¼‰
```
  # å–å¾—é Main çš„ Route Tables
  RT_IDS=$(aws ec2 describe-route-tables \
    --region $REGION \
    --filters "Name=vpc-id,Values=$VPC_ID" \
    --query 'RouteTables[?Associations[0].Main!=`true`].RouteTableId' --output text)

  for RT in $RT_IDS; do
    echo "åˆªé™¤ Route Table: $RT"
    aws ec2 delete-route-table \
      --route-table-id $RT \
      --region $REGION
  done
  echo "Route Tables å·²åˆªé™¤"
  ```

  ---
  7ï¸âƒ£ åˆªé™¤ Security Groupsï¼ˆä¿ç•™ Defaultï¼‰

  - å–å¾—é default çš„ Security Groups
  ```
  SG_IDS=$(aws ec2 describe-security-groups \
    --region $REGION \
    --filters "Name=vpc-id,Values=$VPC_ID" \
    --query 'SecurityGroups[?GroupName!=`default`].GroupId' --output text)

  for SG in $SG_IDS; do
    echo "åˆªé™¤ Security Group: $SG"
    aws ec2 delete-security-group \
      --group-id $SG \
      --region $REGION
  done
  echo "Security Groups å·²åˆªé™¤"


  ---
  8ï¸âƒ£ åˆªé™¤ VPC

  echo "åˆªé™¤ VPC: $VPC_ID"
  aws ec2 delete-vpc \
    --vpc-id $VPC_ID \
    --region $REGION
  echo "VPC å·²åˆªé™¤ï¼"

```