# ç°¡ç­”é¡Œ

1. ä½•ç‚º IaC? é™¤äº† terraform ä»¥å¤–ï¼Œé‚„æœ‰å“ªäº›å·¥å…·å‘¢ï¼Ÿ
    ```
      Infrastructure as Code (åŸºç¤è¨­æ–½å³ç¨‹å¼ç¢¼) æ˜¯ä¸€ç¨®é€éç¨‹å¼ç¢¼ä¾†ç®¡ç†å’Œé…ç½®åŸºç¤è¨­æ–½çš„æ–¹æ³•ï¼Œ
      è€Œéé€éæ‰‹å‹•æ“ä½œæˆ–äº’å‹•å¼è¨­å®šå·¥å…·ã€‚

    â˜… Insight â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    - æ ¸å¿ƒç†å¿µï¼šå°‡åŸºç¤è¨­æ–½ï¼ˆä¼ºæœå™¨ã€ç¶²è·¯ã€è³‡æ–™åº«ç­‰ï¼‰çš„é…ç½®å¯«æˆç¨‹å¼ç¢¼ï¼Œè®“åŸºç¤è¨­æ–½å¯ä»¥åƒè»Ÿé«”ä¸€æ¨£é€²è¡Œç‰ˆæœ¬æ§åˆ¶ã€æ¸¬è©¦å’Œé‡è¤‡éƒ¨ç½²
    - ä¸»è¦å„ªå‹¢ï¼šä¸€è‡´æ€§ï¼ˆé¿å…æ‰‹å‹•è¨­å®šçš„å·®ç•°ï¼‰ã€å¯è¿½è¹¤æ€§ï¼ˆGit ç‰ˆæœ¬æ§åˆ¶ï¼‰ã€è‡ªå‹•åŒ–ï¼ˆCI/CD æ•´åˆï¼‰
    - å…©å¤§æ´¾åˆ¥ï¼šå®£å‘Šå¼ (Declarative) vs å‘½ä»¤å¼ (Imperative)
    â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

    ---
    å¸¸è¦‹çš„ IaC å·¥å…·æ¯”è¼ƒ

    | å·¥å…·               | é¡å‹   | ä¸»è¦ç”¨é€”               | èªè¨€/æ ¼å¼              |
    |--------------------|--------|------------------------|------------------------|
    | Terraform          | å®£å‘Šå¼ | å¤šé›²ç«¯è³‡æºé…ç½®         | HCL                    |
    | AWS CloudFormation | å®£å‘Šå¼ | AWS å°ˆå±¬è³‡æºé…ç½®       | JSON/YAML              |
    | Pulumi             | å®£å‘Šå¼ | å¤šé›²ç«¯ï¼ˆç”¨ç¨‹å¼èªè¨€ï¼‰   | TypeScript/Python/Go   |
    | Ansible            | å‘½ä»¤å¼ | çµ„æ…‹ç®¡ç†ã€éƒ¨ç½²         | YAML                   |
    | Chef               | å‘½ä»¤å¼ | çµ„æ…‹ç®¡ç†               | Ruby DSL               |
    | Puppet             | å®£å‘Šå¼ | çµ„æ…‹ç®¡ç†               | Puppet DSL             |
    | AWS CDK            | å®£å‘Šå¼ | AWS è³‡æºï¼ˆç”¨ç¨‹å¼èªè¨€ï¼‰ | TypeScript/Python/Java |

    ---
    å·¥å…·åˆ†é¡è§£æ

    1ï¸âƒ£ è³‡æºé…ç½®å·¥å…· (Provisioning)

    ç”¨æ–¼å»ºç«‹é›²ç«¯è³‡æºï¼ˆVMã€VPCã€S3 ç­‰ï¼‰ï¼š
    - Terraform - æœ€æµè¡Œï¼Œæ”¯æ´å¤šé›²ç«¯
    - Pulumi - å¯ç”¨ç†Ÿæ‚‰çš„ç¨‹å¼èªè¨€å¯«
    - CloudFormation / CDK - AWS åŸç”Ÿæ–¹æ¡ˆ

    2ï¸âƒ£ çµ„æ…‹ç®¡ç†å·¥å…· (Configuration Management)

    ç”¨æ–¼è¨­å®šå·²å­˜åœ¨çš„ä¼ºæœå™¨ï¼ˆå®‰è£è»Ÿé«”ã€è¨­å®šæª”æ¡ˆç­‰ï¼‰ï¼š
    - Ansible - ç„¡éœ€ agentï¼Œç”¨ SSH é€£ç·š
    - Chef / Puppet - éœ€è¦ agentï¼Œè¼ƒé©åˆå¤§è¦æ¨¡ç’°å¢ƒ

    ---
    Terraform çš„ç¨ç‰¹å„ªå‹¢
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚  ç‚ºä»€éº¼ Terraform é€™éº¼å—æ­¡è¿ï¼Ÿ          â”‚
    â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
    â”‚  âœ“ å¤šé›²ç«¯æ”¯æ´ (AWS, GCP, Azure...)     â”‚
    â”‚  âœ“ ç‹€æ…‹ç®¡ç† (State) è¿½è¹¤è³‡æºè®ŠåŒ–         â”‚
    â”‚  âœ“ Plan åŠŸèƒ½ - é è¦½è®Šæ›´å†åŸ·è¡Œ          â”‚
    â”‚  âœ“ é¾å¤§çš„ Provider ç”Ÿæ…‹ç³»çµ±            â”‚
    â”‚  âœ“ HCL èªæ³•æ˜“è®€æ˜“å­¸                    â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
    ```
2. åŸ·è¡Œ terraform æ™‚ï¼Œæœƒæœ‰ä¸€å€‹æª”æ¡ˆ .tfstateï¼ŒåŠŸèƒ½æ˜¯ä»€éº¼ï¼Ÿ
   ```
     State æª”æ¡ˆæ˜¯ Terraform çš„ã€Œè¨˜æ†¶ã€ï¼Œå®ƒè¨˜éŒ„äº† Terraform ç®¡ç†çš„æ‰€æœ‰è³‡æºçš„ç•¶å‰ç‹€æ…‹ã€‚

    â˜… Insight â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    - æ ¸å¿ƒä½œç”¨ï¼šState æ˜¯ Terraform é…ç½®æª” (.tf) èˆ‡çœŸå¯¦é›²ç«¯è³‡æºä¹‹é–“çš„ã€Œå°ç…§è¡¨ã€
    - é—œéµæ¦‚å¿µï¼šæ²’æœ‰ Stateï¼ŒTerraform ç„¡æ³•çŸ¥é“å“ªäº›è³‡æºæ˜¯å®ƒå»ºç«‹çš„ã€ç›®å‰ç‹€æ…‹ç‚ºä½•
    - é‡è¦æ€§ï¼šState æ±ºå®šäº† terraform plan èƒ½å¦æ­£ç¢ºè¨ˆç®—å‡ºéœ€è¦çš„è®Šæ›´
    â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

    ---
    State çš„é‹ä½œåŸç†

    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚   .tf é…ç½®æª”     â”‚     â”‚   .tfstate       â”‚     â”‚   é›²ç«¯è³‡æº       â”‚
    â”‚   (æœŸæœ›ç‹€æ…‹)     â”‚â”€â”€â”€â”€â–¶â”‚   (å·²çŸ¥ç‹€æ…‹)     â”‚â—€â”€â”€â”€â”€â”‚   (å¯¦éš›ç‹€æ…‹)     â”‚
    â”‚                  â”‚     â”‚                  â”‚     â”‚                  â”‚
    â”‚  resource "aws_  â”‚     â”‚  è¨˜éŒ„è³‡æº IDã€   â”‚     â”‚  AWS/GCP/Azure   â”‚
    â”‚  instance" {...} â”‚     â”‚  å±¬æ€§ã€ä¾è³´é—œä¿‚  â”‚     â”‚  ä¸Šçš„çœŸå¯¦è³‡æº    â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                        â”‚
                                        â–¼
                            terraform plan æ¯”å°
                            ä¸‰è€…ä¾†æ±ºå®šè¦åšä»€éº¼

    ---
    State æª”æ¡ˆçš„ä¸»è¦åŠŸèƒ½

    1ï¸âƒ£ è³‡æºè¿½è¹¤ (Resource Tracking)

    // terraform.tfstate ç¯„ä¾‹ç‰‡æ®µ
    {
        "resources": [
        {
            "type": "aws_instance",
            "name": "web_server",
            "instances": [
            {
                "attributes": {
                "id": "i-0abc123def456",
                "ami": "ami-12345678",
                "instance_type": "t2.micro",
                "public_ip": "52.123.45.67"
                }
            }
            ]
        }
        ]
    }

    2ï¸âƒ£ æ•ˆèƒ½å„ªåŒ–

    - å¿«å–è³‡æºå±¬æ€§ï¼Œé¿å…æ¯æ¬¡éƒ½è¦æŸ¥è©¢é›²ç«¯ API
    - å¤§å‹å°ˆæ¡ˆå¯èƒ½æœ‰æ•¸ç™¾å€‹è³‡æºï¼ŒState è®“ plan æ›´å¿«é€Ÿ

    3ï¸âƒ£ ä¾è³´é—œä¿‚ç®¡ç†

    - è¨˜éŒ„è³‡æºä¹‹é–“çš„ä¾è³´é †åº
    - ç¢ºä¿åˆªé™¤æˆ–æ›´æ–°æ™‚æŒ‰æ­£ç¢ºé †åºåŸ·è¡Œ

    ---
    âš ï¸ State çš„é‡è¦æ³¨æ„äº‹é …

    | å•é¡Œ         | èªªæ˜                     | è§£æ±ºæ–¹æ¡ˆ               |
    |--------------|--------------------------|------------------------|
    | æ•æ„Ÿè³‡è¨Š     | State å¯èƒ½åŒ…å«å¯†ç¢¼ã€é‡‘é‘° | åŠ å¯†å„²å­˜ã€é™åˆ¶å­˜å–æ¬Šé™ |
    | åœ˜éšŠå”ä½œ     | æœ¬åœ° State æœƒé€ æˆè¡çª    | ä½¿ç”¨ Remote Backend    |
    | State éºå¤±   | ç„¡æ³•ç®¡ç†ç¾æœ‰è³‡æº         | å®šæœŸå‚™ä»½ã€ä½¿ç”¨é ç«¯å„²å­˜ |
    | æ‰‹å‹•ä¿®æ”¹é›²ç«¯ | State èˆ‡å¯¦éš›ä¸åŒæ­¥       | åŸ·è¡Œ terraform refresh |

    ---
    Remote Backendï¼ˆåœ˜éšŠå¿…å‚™ï¼‰

    # å°‡ State å­˜æ”¾åœ¨ S3ï¼ˆæ¨è–¦çš„ç”Ÿç”¢ç’°å¢ƒåšæ³•ï¼‰
    terraform {
        backend "s3" {
        bucket         = "my-terraform-state"
        key            = "prod/terraform.tfstate"
        region         = "ap-northeast-1"
        encrypt        = true
        dynamodb_table = "terraform-locks"  # é˜²æ­¢ä¸¦è¡Œä¿®æ”¹
        }
    }

    â˜… Insight â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    - State Lockingï¼šä½¿ç”¨ DynamoDB å¯¦ç¾é–å®šï¼Œé˜²æ­¢å…©äººåŒæ™‚åŸ·è¡Œ terraform apply é€ æˆè¡çª
    - å¸¸è¦‹ Backendï¼šS3 + DynamoDBï¼ˆAWSï¼‰ã€GCSï¼ˆGCPï¼‰ã€Azure Blobã€Terraform Cloud
    - æœ€ä½³å¯¦è¸ï¼šæ°¸é ä¸è¦å°‡ .tfstate æª”æ¡ˆæäº¤åˆ° Gitï¼
    â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

    ---
    å¸¸ç”¨ State æŒ‡ä»¤

    # æŸ¥çœ‹ç›®å‰ State ä¸­çš„è³‡æºæ¸…å–®
    terraform state list

    # æŸ¥çœ‹ç‰¹å®šè³‡æºçš„è©³ç´°è³‡è¨Š
    terraform state show aws_instance.web_server

    # å¾ State ä¸­ç§»é™¤è³‡æºï¼ˆä¸åˆªé™¤å¯¦éš›è³‡æºï¼‰
    terraform state rm aws_instance.web_server

    # å°‡ç¾æœ‰é›²ç«¯è³‡æºåŒ¯å…¥ State
    terraform import aws_instance.web_server i-0abc123def456

    # å¼·åˆ¶é‡æ–°åŒæ­¥ State èˆ‡å¯¦éš›ç‹€æ…‹
    terraform refresh
    ```


3. å¤šäººå”ä½œæ™‚ï¼Œå¦‚ä½•ç¢ºä¿ terraform çš„ç‹€æ…‹ä¸€è‡´æ€§ï¼Ÿ
   ```
    å¤šäººå”ä½œæ™‚ï¼ŒState è¡çªæ˜¯æœ€å¸¸è¦‹çš„å•é¡Œã€‚æƒ³åƒå…©å€‹äººåŒæ™‚åŸ·è¡Œ terraform applyï¼Œå¯èƒ½æœƒé€ æˆè³‡æºé‡è¤‡å»ºç«‹æˆ–ç‹€æ…‹æ··äº‚ã€‚

    â˜… Insight â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    - æ ¸å¿ƒæŒ‘æˆ°ï¼šState æ˜¯å–®ä¸€ä¾†æºï¼ˆSingle Source of Truthï¼‰ï¼Œå¤šäººåŒæ™‚ä¿®æ”¹æœƒå°è‡´ä¸ä¸€è‡´
    - è§£æ±ºä¸‰è¦ç´ ï¼šRemote Backendï¼ˆé›†ä¸­å„²å­˜ï¼‰+ State Lockingï¼ˆé˜²æ­¢ä¸¦è¡Œï¼‰+ ç‰ˆæœ¬æ§åˆ¶ï¼ˆè¿½è¹¤è®Šæ›´ï¼‰
    - é€²éšæ–¹æ¡ˆï¼šCI/CD Pipeline çµ±ä¸€åŸ·è¡Œ Terraformï¼Œé¿å…æœ¬åœ°åŸ·è¡Œ
    â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

    ---
    å•é¡Œæƒ…å¢ƒï¼šæ²’æœ‰ç‹€æ…‹é–å®šæœƒç™¼ç”Ÿä»€éº¼ï¼Ÿ

    æ™‚é–“è»¸ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¶

    ğŸ‘© Alice                          ğŸ‘¨ Bob
        â”‚                                 â”‚
        â”œâ”€ terraform plan               â”‚
        â”‚  (è®€å– state v1)               â”œâ”€ terraform plan
        â”‚                                 â”‚  (è®€å– state v1)
        â”œâ”€ terraform apply               â”‚
        â”‚  (å»ºç«‹ EC2-A)                  â”‚
        â”‚  (å¯«å…¥ state v2)               â”œâ”€ terraform apply
        â”‚                                 â”‚  (å»ºç«‹ EC2-B)
        â–¼                                 â”‚  (è¦†è“‹ stateï¼Œéºå¤± EC2-A è¨˜éŒ„ï¼) ğŸ˜±
                                        â–¼

    çµæœï¼šEC2-A è®Šæˆã€Œå­¤å…’è³‡æºã€ï¼ŒTerraform ä¸å†ç®¡ç†å®ƒ

    ---
    è§£æ±ºæ–¹æ¡ˆä¸€è¦½

    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚                  Terraform åœ˜éšŠå”ä½œæ¶æ§‹                      â”‚
    â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
    â”‚                                                             â”‚
    â”‚   é–‹ç™¼è€… A â”€â”€â”                                              â”‚
    â”‚              â”‚      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚
    â”‚   é–‹ç™¼è€… B â”€â”€â”¼â”€â”€â”€â”€â”€â–¶â”‚   Remote    â”‚â”€â”€â”€â”€â–¶â”‚   é›²ç«¯      â”‚    â”‚
    â”‚              â”‚      â”‚   Backend   â”‚     â”‚   è³‡æº      â”‚    â”‚
    â”‚   é–‹ç™¼è€… C â”€â”€â”˜      â”‚  (S3/GCS)   â”‚     â”‚             â”‚    â”‚
    â”‚                     â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚
    â”‚                            â”‚                                â”‚
    â”‚                     â”Œâ”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”                        â”‚
    â”‚                     â”‚   State     â”‚                        â”‚
    â”‚                     â”‚   Locking   â”‚                        â”‚
    â”‚                     â”‚ (DynamoDB)  â”‚                        â”‚
    â”‚                     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                        â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

    ---
    æ–¹æ¡ˆ 1ï¼šRemote Backend + State Lockingï¼ˆAWSï¼‰

    # backend.tf
    terraform {
        backend "s3" {
        bucket         = "company-terraform-state"
        key            = "projects/web-app/terraform.tfstate"
        region         = "ap-northeast-1"

        # ğŸ” åŠ å¯†å„²å­˜
        encrypt        = true

        # ğŸ”’ State Lockingï¼ˆé—œéµï¼ï¼‰
        dynamodb_table = "terraform-state-locks"
        }
    }

    å»ºç«‹ Locking ç”¨çš„ DynamoDB Table

    # é€™å€‹è¦å…ˆç”¨ local backend å»ºç«‹ï¼Œæˆ–æ‰‹å‹•å»ºç«‹
    resource "aws_dynamodb_table" "terraform_locks" {
        name         = "terraform-state-locks"
        billing_mode = "PAY_PER_REQUEST"
        hash_key     = "LockID"

        attribute {
        name = "LockID"
        type = "S"
        }

        tags = {
        Name = "Terraform State Lock Table"
        }
    }

    ---
    æ–¹æ¡ˆ 2ï¼šTerraform Cloud / Enterpriseï¼ˆæ¨è–¦ï¼‰

    terraform {
        cloud {
        organization = "my-company"

        workspaces {
            name = "web-app-prod"
        }
        }
    }

    â˜… Insight â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    - Terraform Cloud å„ªå‹¢ï¼šè‡ªå‹• Lockingã€State ç‰ˆæœ¬æ­·å²ã€æ¬Šé™æ§åˆ¶ã€é ç«¯åŸ·è¡Œ
    - å…è²»æ–¹æ¡ˆï¼šå°åœ˜éšŠï¼ˆâ‰¤5äººï¼‰å¯å…è²»ä½¿ç”¨åŸºæœ¬åŠŸèƒ½
    - å®‰å…¨æ€§ï¼šæ•æ„Ÿè®Šæ•¸å¯åœ¨ UI è¨­å®šï¼Œä¸éœ€å¯«åœ¨ç¨‹å¼ç¢¼ä¸­
    â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

    ---
    æ–¹æ¡ˆ 3ï¼šCI/CD Pipeline çµ±ä¸€åŸ·è¡Œï¼ˆæœ€ä½³å¯¦è¸ï¼‰

    # .github/workflows/terraform.yml
    name: Terraform

    on:
        pull_request:
        branches: [main]
        push:
        branches: [main]

    jobs:
        terraform:
        runs-on: ubuntu-latest
        steps:
            - uses: actions/checkout@v4

            - name: Setup Terraform
            uses: hashicorp/setup-terraform@v3

            - name: Terraform Init
            run: terraform init

            - name: Terraform Plan
            if: github.event_name == 'pull_request'
            run: terraform plan -no-color

            # åªæœ‰ merge åˆ° main æ‰åŸ·è¡Œ apply
            - name: Terraform Apply
            if: github.ref == 'refs/heads/main'
            run: terraform apply -auto-approve

    CI/CD æµç¨‹åœ–

    é–‹ç™¼è€… â”€â–¶ å»ºç«‹ PR â”€â–¶ è‡ªå‹• Plan â”€â–¶ Code Review â”€â–¶ Merge â”€â–¶ è‡ªå‹• Apply
                            â”‚              â”‚
                            â–¼              â–¼
                        Plan çµæœé¡¯ç¤º    å¯©æ ¸è®Šæ›´æ˜¯å¦å®‰å…¨
                        åœ¨ PR Comment
    ---
    åœ˜éšŠå”ä½œæœ€ä½³å¯¦è¸æ¸…å–®

    | å¯¦è¸                       | èªªæ˜                            |
    |----------------------------|---------------------------------|
    | âœ… æ°¸é ä½¿ç”¨ Remote Backend | çµ•ä¸ç”¨ local state              |
    | âœ… å•Ÿç”¨ State Locking      | é˜²æ­¢ä¸¦è¡Œä¿®æ”¹                    |
    | âœ… é€é CI/CD åŸ·è¡Œ         | é¿å…æœ¬åœ°ç›´æ¥ apply              |
    | âœ… PR å¯©æ ¸æµç¨‹             | æ‰€æœ‰è®Šæ›´éœ€è¦ review             |
    | âœ… ç’°å¢ƒåˆ†é›¢                | dev/staging/prod ä½¿ç”¨ä¸åŒ State |
    | âœ… State ç‰ˆæœ¬å‚™ä»½          | S3 versioning å•Ÿç”¨              |
    | â›” ä¸è¦ commit .tfstate    | åŠ å…¥ .gitignore                 |
    | â›” ä¸è¦æ‰‹å‹•ä¿®æ”¹é›²ç«¯è³‡æº    | é€é Terraform ç®¡ç†             |
    ---
    ç’°å¢ƒåˆ†é›¢ç­–ç•¥

    terraform/
    â”œâ”€â”€ modules/           # å…±ç”¨æ¨¡çµ„
    â”‚   â””â”€â”€ vpc/
    â”œâ”€â”€ environments/
    â”‚   â”œâ”€â”€ dev/
    â”‚   â”‚   â”œâ”€â”€ main.tf
    â”‚   â”‚   â””â”€â”€ backend.tf  # key = "dev/terraform.tfstate"
    â”‚   â”œâ”€â”€ staging/
    â”‚   â”‚   â”œâ”€â”€ main.tf
    â”‚   â”‚   â””â”€â”€ backend.tf  # key = "staging/terraform.tfstate"
    â”‚   â””â”€â”€ prod/
    â”‚       â”œâ”€â”€ main.tf
    â”‚       â””â”€â”€ backend.tf  # key = "prod/terraform.tfstate"

    ```

4. ä½•ç‚ºå†ªç­‰æ€§ï¼Ÿä»–åœ¨ IaC å·¥å…·ä¸­å¸¶ä¾†æ€æ¨£çš„å¥½è™•ï¼Ÿ

  ```
  å†ªç­‰æ€§æ˜¯ä¸€å€‹æ•¸å­¸èˆ‡é›»è…¦ç§‘å­¸çš„æ¦‚å¿µï¼šåŸ·è¡Œä¸€æ¬¡å’ŒåŸ·è¡Œå¤šæ¬¡ï¼Œçµæœéƒ½ç›¸åŒã€‚

    â˜… Insight â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    - æ•¸å­¸å®šç¾©ï¼šf(f(x)) = f(x)ï¼Œä¾‹å¦‚å–çµ•å°å€¼ ||-5|| = |-5| = 5
    - IaC æ„ç¾©ï¼šç„¡è«–åŸ·è¡Œ terraform apply å¹¾æ¬¡ï¼Œæœ€çµ‚ç‹€æ…‹éƒ½ä¸€æ¨£
    - æ ¸å¿ƒåƒ¹å€¼ï¼šå®‰å…¨åœ°é‡è¤‡åŸ·è¡Œï¼Œä¸æ€•ã€Œå¤šåšã€é€ æˆå‰¯ä½œç”¨
    â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

    ---
    å†ªç­‰ vs éå†ªç­‰ å°æ¯”

    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚                      éå†ªç­‰æ“ä½œ (å±éšªï¼)                         â”‚
    â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
    â”‚                                                                 â”‚
    â”‚   è…³æœ¬ï¼šcreate_server.sh                                        â”‚
    â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                  â”‚
    â”‚   â”‚  aws ec2 run-instances --image-id ...   â”‚                  â”‚
    â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                  â”‚
    â”‚                                                                 â”‚
    â”‚   åŸ·è¡Œç¬¬ 1 æ¬¡ â†’ å»ºç«‹ 1 å° EC2  âœ“                                â”‚
    â”‚   åŸ·è¡Œç¬¬ 2 æ¬¡ â†’ å»ºç«‹ 2 å° EC2  ğŸ˜±                               â”‚
    â”‚   åŸ·è¡Œç¬¬ 3 æ¬¡ â†’ å»ºç«‹ 3 å° EC2  ğŸ˜±ğŸ˜±                             â”‚
    â”‚                                                                 â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚                      å†ªç­‰æ“ä½œ (å®‰å…¨ï¼)                           â”‚
    â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
    â”‚                                                                 â”‚
    â”‚   Terraformï¼šmain.tf                                            â”‚
    â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                  â”‚
    â”‚   â”‚  resource "aws_instance" "web" {        â”‚                  â”‚
    â”‚   â”‚    ami           = "ami-123"            â”‚                  â”‚
    â”‚   â”‚    instance_type = "t2.micro"           â”‚                  â”‚
    â”‚   â”‚  }                                      â”‚                  â”‚
    â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                  â”‚
    â”‚                                                                 â”‚
    â”‚   åŸ·è¡Œç¬¬ 1 æ¬¡ â†’ å»ºç«‹ 1 å° EC2  âœ“                                â”‚
    â”‚   åŸ·è¡Œç¬¬ 2 æ¬¡ â†’ ç„¡è®Šæ›´ (No changes)  âœ“                          â”‚
    â”‚   åŸ·è¡Œç¬¬ 3 æ¬¡ â†’ ç„¡è®Šæ›´ (No changes)  âœ“                          â”‚
    â”‚                                                                 â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

    ---
    Terraform å¦‚ä½•å¯¦ç¾å†ªç­‰æ€§ï¼Ÿ

                  terraform apply æµç¨‹
                        â”‚
                        â–¼
            â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
            â”‚  è®€å– .tf é…ç½®æª”    â”‚ â”€â”€â–¶ æœŸæœ›ç‹€æ…‹ (Desired State)
            â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                        â”‚
                        â–¼
            â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
            â”‚  è®€å– .tfstate      â”‚ â”€â”€â–¶ å·²çŸ¥ç‹€æ…‹ (Known State)
            â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                        â”‚
                        â–¼
            â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
            â”‚  æŸ¥è©¢é›²ç«¯ API       â”‚ â”€â”€â–¶ å¯¦éš›ç‹€æ…‹ (Actual State)
            â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                        â”‚
                        â–¼
            â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
            â”‚  æ¯”è¼ƒå·®ç•° (Diff)    â”‚
            â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                        â”‚
              â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
              â–¼                   â–¼
        æœ‰å·®ç•°                 ç„¡å·®ç•°
        åŸ·è¡Œè®Šæ›´               ä¸åšä»»ä½•äº‹
        (Create/Update/Delete)  (No changes)

    ---
    å†ªç­‰æ€§åœ¨ IaC ä¸­çš„å¥½è™•

    1ï¸âƒ£ å®‰å…¨åœ°é‡è¤‡åŸ·è¡Œ

    # ä¸å°å¿ƒåŸ·è¡Œå…©æ¬¡ä¹Ÿæ²’é—œä¿‚ï¼
    $ terraform apply
    Apply complete! Resources: 0 added, 0 changed, 0 destroyed.

    # CI/CD é‡è©¦ä¹Ÿå®‰å…¨
    $ terraform apply
    Apply complete! Resources: 0 added, 0 changed, 0 destroyed.

    2ï¸âƒ£ è‡ªå‹•ä¿®å¾©æ¼‚ç§» (Drift)

    æƒ…å¢ƒï¼šæœ‰äººæ‰‹å‹•åœ¨ AWS Console æ”¹äº†è¨­å®š

    åŸ·è¡Œå‰ï¼š
      .tf é…ç½®ï¼šinstance_type = "t2.micro"
      å¯¦éš›ç‹€æ…‹ï¼šinstance_type = "t2.large"  â† è¢«æ‰‹å‹•æ”¹é

    åŸ·è¡Œ terraform apply å¾Œï¼š
      å¯¦éš›ç‹€æ…‹ï¼šinstance_type = "t2.micro"  â† è‡ªå‹•ä¿®æ­£å›ä¾†ï¼

    3ï¸âƒ£ å®£å‘Šå¼ = å¤©ç”Ÿå†ªç­‰

    | æ–¹å¼   | ç¯„ä¾‹                | å†ªç­‰æ€§          |
    |--------|---------------------|-----------------|
    | å®£å‘Šå¼ | ã€Œæˆ‘è¦ 3 å°ä¼ºæœå™¨ã€ | âœ… å¤©ç”Ÿå†ªç­‰     |
    | å‘½ä»¤å¼ | ã€Œå»ºç«‹ 1 å°ä¼ºæœå™¨ã€ | âŒ éœ€è¦é¡å¤–è™•ç† |

    # å®£å‘Šå¼ï¼ˆTerraformï¼‰- æè¿°ã€Œæœ€çµ‚ç‹€æ…‹ã€
    resource "aws_instance" "web" {
      count         = 3  # æˆ‘è¦ 3 å°
      ami           = "ami-123"
      instance_type = "t2.micro"
    }
    # ä¸ç®¡ç¾åœ¨æœ‰å¹¾å°ï¼Œæœ€çµ‚éƒ½æœƒæ˜¯ 3 å°

    # å‘½ä»¤å¼ï¼ˆShell Scriptï¼‰- æè¿°ã€Œå‹•ä½œã€
    for i in {1..3}; do
      aws ec2 run-instances --image-id ami-123
    done
    # æ¯æ¬¡åŸ·è¡Œéƒ½æœƒã€Œå†å»º 3 å°ã€ï¼

    4ï¸âƒ£ ç°¡åŒ–éŒ¯èª¤æ¢å¾©

    æƒ…å¢ƒï¼šterraform apply åŸ·è¡Œåˆ°ä¸€åŠç¶²è·¯æ–·ç·š

    å‚³çµ±è…³æœ¬ï¼š
      ğŸ˜± éœ€è¦æ‰‹å‹•æª¢æŸ¥å“ªäº›åšäº†ã€å“ªäº›æ²’åš
      ğŸ˜± å¯èƒ½éœ€è¦å¯« rollback é‚è¼¯

    Terraformï¼š
      ğŸ˜Š é‡æ–°åŸ·è¡Œ terraform apply
      ğŸ˜Š è‡ªå‹•è·³éå·²å®Œæˆçš„ï¼Œç¹¼çºŒæœªå®Œæˆçš„

    ---
    å†ªç­‰æ€§çš„å¯¦éš›æ‡‰ç”¨å ´æ™¯

    â˜… Insight â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    - CI/CD Pipelineï¼šæ¯æ¬¡ deploy éƒ½åŸ·è¡Œ terraform applyï¼Œä¸éœ€åˆ¤æ–·ã€Œæ˜¯å¦ç¬¬ä¸€æ¬¡ã€
    - ç½é›£æ¢å¾©ï¼šç›´æ¥åœ¨æ–°å€åŸŸåŸ·è¡Œç›¸åŒé…ç½®ï¼Œå¿«é€Ÿé‡å»ºç’°å¢ƒ
    - ç’°å¢ƒä¸€è‡´æ€§ï¼šdev/staging/prod ç”¨ç›¸åŒ .tf æª”æ¡ˆï¼Œç¢ºä¿æ¶æ§‹ä¸€è‡´
    â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

    ---
    æ³¨æ„ï¼šä¸¦éæ‰€æœ‰æ“ä½œéƒ½å†ªç­‰

    # âš ï¸ é€™å€‹ä¸æ˜¯å®Œå…¨å†ªç­‰ï¼
    resource "null_resource" "run_script" {
      provisioner "local-exec" {
        command = "echo 'Hello' >> log.txt"  # æ¯æ¬¡éƒ½æœƒè¿½åŠ ä¸€è¡Œ
      }
    }

    # âœ… æ”¹æˆå†ªç­‰çš„å¯«æ³•
    resource "null_resource" "run_script" {
      provisioner "local-exec" {
        command = "echo 'Hello' > log.txt"  # è¦†è“‹è€Œéè¿½åŠ 
      }
    }

    Terraform ä¸­éœ€è¦æ³¨æ„çš„éå†ªç­‰å…ƒç´ 

    | å…ƒç´                    | å•é¡Œ               | å»ºè­°              |
    |------------------------|--------------------|-------------------|
    | local-exec provisioner | è…³æœ¬æœ¬èº«å¯èƒ½éå†ªç­‰ | ç¢ºä¿è…³æœ¬å†ªç­‰è¨­è¨ˆ  |
    | random_* è³‡æº          | æ¯æ¬¡å¯èƒ½ç”¢ç”Ÿä¸åŒå€¼ | ä½¿ç”¨ keepers å›ºå®š |
    | å¤–éƒ¨è³‡æ–™ä¾†æº           | API å›å‚³å€¼å¯èƒ½è®ŠåŒ– | è€ƒæ…®å¿«å–æˆ–å›ºå®šå€¼  |

    ---
  ```

5. ä½•ç‚º terraform moduleï¼Œå®ƒè§£æ±ºäº†ä»€éº¼å•é¡Œï¼Ÿ
```
Module æ˜¯ Terraform é…ç½®çš„å¯é‡ç”¨å°è£å–®å…ƒï¼Œå°±åƒç¨‹å¼èªè¨€ä¸­çš„å‡½æ•¸æˆ–é¡åˆ¥ï¼Œè®“ä½ å¯ä»¥å°‡åŸºç¤è¨­æ–½æ‰“åŒ…ã€é‡ç”¨å’Œåˆ†äº«ã€‚

  â˜… Insight â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  - æœ¬è³ªï¼šModule å°±æ˜¯ä¸€å€‹åŒ…å« .tf æª”æ¡ˆçš„ç›®éŒ„ï¼Œå¯è¢«å…¶ä»–é…ç½®å¼•ç”¨
  - è¨­è¨ˆç†å¿µï¼šDRY (Don't Repeat Yourself) â€” å¯«ä¸€æ¬¡ï¼Œåˆ°è™•ä½¿ç”¨
  - å¯¦éš›ä¸Šï¼šä½ å·²ç¶“åœ¨ç”¨ Moduleï¼æ¯å€‹ Terraform å°ˆæ¡ˆçš„æ ¹ç›®éŒ„å°±æ˜¯ Root Module
  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

  ---
  Module è§£æ±ºçš„å•é¡Œ

  å•é¡Œ 1ï¼šç¨‹å¼ç¢¼é‡è¤‡ (Code Duplication)

  æ²’æœ‰ Module çš„ä¸–ç•Œ ğŸ˜±
  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  environments/
  â”œâ”€â”€ dev/
  â”‚   â””â”€â”€ main.tf      # VPC + Subnet + Security Group + EC2...ï¼ˆ200è¡Œï¼‰
  â”œâ”€â”€ staging/
  â”‚   â””â”€â”€ main.tf      # è¤‡è£½è²¼ä¸ŠåŒæ¨£ 200 è¡Œï¼Œæ”¹å¹¾å€‹åƒæ•¸
  â””â”€â”€ prod/
      â””â”€â”€ main.tf      # åˆè¤‡è£½è²¼ä¸Šä¸€æ¬¡...

  å•é¡Œï¼š
  â€¢ æ”¹ä¸€å€‹è¨­å®šè¦æ”¹ä¸‰å€‹åœ°æ–¹
  â€¢ å®¹æ˜“æ¼æ”¹ï¼Œç’°å¢ƒä¸ä¸€è‡´
  â€¢ ç¨‹å¼ç¢¼è†¨è„¹ï¼Œé›£ä»¥ç¶­è­·

  ä½¿ç”¨ Module å¾Œ ğŸ˜Š
  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  modules/
  â””â”€â”€ web-app/
      â”œâ”€â”€ main.tf      # VPC + Subnet + Security Group + EC2
      â”œâ”€â”€ variables.tf # å¯é…ç½®çš„åƒæ•¸
      â””â”€â”€ outputs.tf   # è¼¸å‡ºå€¼

  environments/
  â”œâ”€â”€ dev/
  â”‚   â””â”€â”€ main.tf      # åªéœ€ 10 è¡Œå‘¼å« module
  â”œâ”€â”€ staging/
  â”‚   â””â”€â”€ main.tf      # åŒæ¨£ 10 è¡Œï¼Œä¸åŒåƒæ•¸
  â””â”€â”€ prod/
      â””â”€â”€ main.tf      # åŒæ¨£ 10 è¡Œï¼Œä¸åŒåƒæ•¸

  å•é¡Œ 2ï¼šçŸ¥è­˜å°è£èˆ‡æ¨™æº–åŒ–

  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
  â”‚  æƒ…å¢ƒï¼šå…¬å¸æœ‰ 10 å€‹åœ˜éšŠéƒ½éœ€è¦å»ºç«‹ AWS ç¶²è·¯æ¶æ§‹               â”‚
  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
  â”‚                                                             â”‚
  â”‚  æ²’æœ‰ Moduleï¼š                                              â”‚
  â”‚  â€¢ æ¯å€‹åœ˜éšŠè‡ªå·±ç ”ç©¶ VPCã€Subnetã€Route Table æ€éº¼è¨­å®š       â”‚
  â”‚  â€¢ æœ‰äººæ¼è¨­ NAT Gatewayï¼Œæœ‰äººå¿˜è¨˜é–‹ Flow Logs               â”‚
  â”‚  â€¢ å®‰å…¨æ¨™æº–ä¸ä¸€è‡´ï¼Œç¶­é‹å›°é›£                                 â”‚
  â”‚                                                             â”‚
  â”‚  æœ‰ Moduleï¼š                                                â”‚
  â”‚  â€¢ å¹³å°åœ˜éšŠå»ºç«‹æ¨™æº–åŒ–çš„ vpc-module                          â”‚
  â”‚  â€¢ å…§å»ºæœ€ä½³å¯¦è¸ï¼šå®‰å…¨ç¾¤çµ„è¦å‰‡ã€æ—¥èªŒã€æ¨™ç±¤                   â”‚
  â”‚  â€¢ å…¶ä»–åœ˜éšŠåªéœ€å‘¼å«ï¼Œä¸éœ€äº†è§£åº•å±¤ç´°ç¯€                       â”‚
  â”‚                                                             â”‚
  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

  ---
  Module çš„åŸºæœ¬çµæ§‹

  modules/vpc/
  â”œâ”€â”€ main.tf          # è³‡æºå®šç¾©
  â”œâ”€â”€ variables.tf     # è¼¸å…¥è®Šæ•¸ï¼ˆåƒæ•¸ï¼‰
  â”œâ”€â”€ outputs.tf       # è¼¸å‡ºå€¼ï¼ˆå›å‚³ï¼‰
  â”œâ”€â”€ versions.tf      # Provider ç‰ˆæœ¬è¦æ±‚
  â””â”€â”€ README.md        # ä½¿ç”¨èªªæ˜

  ç¯„ä¾‹ï¼šå»ºç«‹ä¸€å€‹ç°¡å–®çš„ VPC Module

  # modules/vpc/variables.tf
  variable "vpc_name" {
    description = "VPC åç¨±"
    type        = string
  }

  variable "vpc_cidr" {
    description = "VPC CIDR ç¯„åœ"
    type        = string
    default     = "10.0.0.0/16"
  }

  variable "environment" {
    description = "ç’°å¢ƒåç¨± (dev/staging/prod)"
    type        = string
  }

  # modules/vpc/main.tf
  resource "aws_vpc" "this" {
    cidr_block           = var.vpc_cidr
    enable_dns_hostnames = true
    enable_dns_support   = true

    tags = {
      Name        = var.vpc_name
      Environment = var.environment
      ManagedBy   = "Terraform"
    }
  }

  resource "aws_subnet" "public" {
    vpc_id                  = aws_vpc.this.id
    cidr_block              = cidrsubnet(var.vpc_cidr, 8, 1)
    map_public_ip_on_launch = true

    tags = {
      Name = "${var.vpc_name}-public"
    }
  }

  # modules/vpc/outputs.tf
  output "vpc_id" {
    description = "VPC ID"
    value       = aws_vpc.this.id
  }

  output "public_subnet_id" {
    description = "Public Subnet ID"
    value       = aws_subnet.public.id
  }

  ---
  å¦‚ä½•ä½¿ç”¨ Module

  # environments/dev/main.tf

  # å‘¼å«æœ¬åœ° Module
  module "vpc" {
    source = "../../modules/vpc"

    vpc_name    = "dev-vpc"
    vpc_cidr    = "10.1.0.0/16"
    environment = "dev"
  }

  # ä½¿ç”¨ Module çš„è¼¸å‡º
  resource "aws_instance" "web" {
    ami           = "ami-123456"
    instance_type = "t2.micro"
    subnet_id     = module.vpc.public_subnet_id  # å¼•ç”¨ module è¼¸å‡º
  }

  # environments/prod/main.tf

  module "vpc" {
    source = "../../modules/vpc"

    vpc_name    = "prod-vpc"
    vpc_cidr    = "10.100.0.0/16"  # ä¸åŒçš„ CIDR
    environment = "prod"
  }

  ---
  Module çš„ä¾†æº (Source)

  â˜… Insight â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  - æœ¬åœ°è·¯å¾‘ï¼šsource = "./modules/vpc" â€” å°ˆæ¡ˆå…§éƒ¨å…±ç”¨
  - Git Repoï¼šsource = "git::https://github.com/company/modules.git//vpc" â€” è·¨å°ˆæ¡ˆå…±ç”¨
  - Terraform Registryï¼šsource = "terraform-aws-modules/vpc/aws" â€” ç¤¾ç¾¤ç¶­è­·çš„æ¨¡çµ„
  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

  # ä½¿ç”¨ Terraform Registry çš„å®˜æ–¹ VPC Module
  module "vpc" {
    source  = "terraform-aws-modules/vpc/aws"
    version = "5.0.0"  # é–å®šç‰ˆæœ¬å¾ˆé‡è¦ï¼

    name = "my-vpc"
    cidr = "10.0.0.0/16"

    azs             = ["ap-northeast-1a", "ap-northeast-1c"]
    private_subnets = ["10.0.1.0/24", "10.0.2.0/24"]
    public_subnets  = ["10.0.101.0/24", "10.0.102.0/24"]

    enable_nat_gateway = true
  }

  ---
  Module è¨­è¨ˆæœ€ä½³å¯¦è¸

  | åŸå‰‡       | èªªæ˜                                             |
  |------------|--------------------------------------------------|
  | å–®ä¸€è·è²¬   | ä¸€å€‹ Module åªåšä¸€ä»¶äº‹ï¼ˆVPCã€RDSã€ECS å„è‡ªç¨ç«‹ï¼‰ |
  | é©ç•¶æŠ½è±¡   | æš´éœ²å¿…è¦åƒæ•¸ï¼Œéš±è—å¯¦ä½œç´°ç¯€                       |
  | ç‰ˆæœ¬æ§åˆ¶   | ä½¿ç”¨ Git tag æˆ– version é–å®š                     |
  | æ–‡ä»¶å®Œæ•´   | æ¯å€‹ variable å’Œ output éƒ½æœ‰ description         |
  | é è¨­å€¼åˆç† | è®“ä½¿ç”¨è€…å¯ä»¥å¿«é€Ÿé–‹å§‹ï¼Œé€²éšéœ€æ±‚å†èª¿æ•´             |

  ---
  Module å‘¼å«è¦–è¦ºåŒ–

                      Root Module (environments/prod/)
                                â”‚
             â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
             â–¼                  â–¼                  â–¼
      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
      â”‚  module     â”‚   â”‚  module     â”‚   â”‚  module     â”‚
      â”‚  "vpc"      â”‚   â”‚  "rds"      â”‚   â”‚  "ecs"      â”‚
      â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜   â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜   â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜
             â”‚                 â”‚                 â”‚
             â–¼                 â–¼                 â–¼
      modules/vpc/      modules/rds/      modules/ecs/
      â”œâ”€â”€ main.tf       â”œâ”€â”€ main.tf       â”œâ”€â”€ main.tf
      â”œâ”€â”€ variables.tf  â”œâ”€â”€ variables.tf  â”œâ”€â”€ variables.tf
      â””â”€â”€ outputs.tf    â””â”€â”€ outputs.tf    â””â”€â”€ outputs.tf

  ---
  ç¸½çµï¼šModule è§£æ±ºçš„å•é¡Œ

  | å•é¡Œ       | Module çš„è§£æ±ºæ–¹æ¡ˆ        |
  |------------|--------------------------|
  | ç¨‹å¼ç¢¼é‡è¤‡ | å°è£å¾Œé‡è¤‡ä½¿ç”¨           |
  | ç’°å¢ƒä¸ä¸€è‡´ | åŒä¸€ Moduleï¼Œä¸åŒåƒæ•¸    |
  | çŸ¥è­˜åˆ†æ•£   | æœ€ä½³å¯¦è¸å°è£åœ¨ Module ä¸­ |
  | ç¶­è­·å›°é›£   | æ”¹ä¸€è™•ï¼Œè™•è™•ç”Ÿæ•ˆ         |
  | åœ˜éšŠå”ä½œ   | æ¨™æº–åŒ–çš„åŸºç¤è¨­æ–½å…ƒä»¶     |
  | å­¸ç¿’æ›²ç·š   | ä½¿ç”¨è€…ä¸éœ€äº†è§£åº•å±¤ç´°ç¯€   |

  ---
```


6. terraform çš„è³‡æºå‰µå»ºé †åºç‚ºä½•ï¼Ÿå¦‚ä½•å»æ§åˆ¶ç›¸ä¾æ€§ï¼Ÿ
```
Terraform æœƒè‡ªå‹•åˆ†æè³‡æºä¹‹é–“çš„ç›¸ä¾é—œä¿‚ï¼Œä¸¦å»ºç«‹ä¸€å€‹æœ‰å‘ç„¡ç’°åœ– (DAG) ä¾†æ±ºå®šåŸ·è¡Œé †åºã€‚

  â˜… Insight â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  - æ ¸å¿ƒæ©Ÿåˆ¶ï¼šTerraform ä¸æ˜¯é€è¡ŒåŸ·è¡Œï¼Œè€Œæ˜¯åˆ†æä¾è³´å¾Œä¸¦è¡Œå»ºç«‹ç„¡ä¾è³´çš„è³‡æº
  - éš±å¼ä¾è³´ï¼šç•¶ resource A å¼•ç”¨ resource B çš„å±¬æ€§æ™‚ï¼Œè‡ªå‹•å»ºç«‹ä¾è³´é—œä¿‚
  - é¡¯å¼ä¾è³´ï¼šä½¿ç”¨ depends_on æ‰‹å‹•æŒ‡å®šä¾è³´ï¼ˆåƒ…åœ¨éš±å¼ä¾è³´ç„¡æ³•æ¶µè“‹æ™‚ä½¿ç”¨ï¼‰
  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

  ---
  Terraform çš„ä¾è³´åœ– (Dependency Graph)

  terraform graph | dot -Tpng > graph.png   # å¯è¦–åŒ–ä¾è³´é—œä¿‚

                      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                      â”‚   aws_vpc       â”‚
                      â”‚   "main"        â”‚
                      â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                               â”‚
                â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                â–¼              â–¼              â–¼
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â”‚ aws_subnet   â”‚ â”‚ aws_subnet   â”‚ â”‚ aws_internet â”‚
        â”‚ "public_a"   â”‚ â”‚ "public_b"   â”‚ â”‚ _gateway     â”‚
        â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜
               â”‚                â”‚                â”‚
               â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                â–¼
                      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                      â”‚ aws_route_table â”‚
                      â”‚ "public"        â”‚
                      â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                               â”‚
                               â–¼
                      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                      â”‚ aws_instance    â”‚
                      â”‚ "web"           â”‚
                      â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

  å»ºç«‹é †åºï¼šVPC â†’ (Subnet A, Subnet B, IGW ä¸¦è¡Œ) â†’ Route Table â†’ Instance
  åˆªé™¤é †åºï¼šç›¸åï¼Instance â†’ Route Table â†’ (Subnet A, Subnet B, IGW ä¸¦è¡Œ) â†’ VPC

  ---
  éš±å¼ä¾è³´ (Implicit Dependencies)

  æœ€å¸¸è¦‹ä¹Ÿæœ€æ¨è–¦çš„æ–¹å¼ â€” Terraform è‡ªå‹•åµæ¸¬

  # 1. å…ˆå»ºç«‹ VPC
  resource "aws_vpc" "main" {
    cidr_block = "10.0.0.0/16"
  }

  # 2. Subnet å¼•ç”¨äº† vpc_idï¼Œæ‰€ä»¥ Terraform çŸ¥é“è¦å…ˆå»º VPC
  resource "aws_subnet" "public" {
    vpc_id     = aws_vpc.main.id  # â† éš±å¼ä¾è³´ï¼
    cidr_block = "10.0.1.0/24"
  }

  # 3. Instance å¼•ç”¨äº† subnet_idï¼Œæ‰€ä»¥è¦å…ˆå»º Subnet
  resource "aws_instance" "web" {
    ami           = "ami-123456"
    instance_type = "t2.micro"
    subnet_id     = aws_subnet.public.id  # â† éš±å¼ä¾è³´ï¼
  }

  ä¾è³´éˆè‡ªå‹•å»ºç«‹ï¼š
  aws_vpc.main â†’ aws_subnet.public â†’ aws_instance.web

  ---
  é¡¯å¼ä¾è³´ (Explicit Dependencies)

  ç•¶éš±å¼ä¾è³´ç„¡æ³•è¡¨é”çœŸå¯¦ä¾è³´é—œä¿‚æ™‚ä½¿ç”¨ depends_on

  æƒ…å¢ƒï¼šIAM Role å¿…é ˆåœ¨ EC2 ä¹‹å‰å»ºç«‹

  resource "aws_iam_role" "ec2_role" {
    name = "ec2-role"
    
    assume_role_policy = jsonencode({
      Version = "2012-10-17"
      Statement = [{
        Action = "sts:AssumeRole"
        Effect = "Allow"
        Principal = {
          Service = "ec2.amazonaws.com"
        }
      }]
    })
  }

  resource "aws_iam_instance_profile" "ec2_profile" {
    name = "ec2-profile"
    role = aws_iam_role.ec2_role.name
  }

  resource "aws_instance" "web" {
    ami                  = "ami-123456"
    instance_type        = "t2.micro"
    iam_instance_profile = aws_iam_instance_profile.ec2_profile.name

    # é›–ç„¶å·²ç¶“å¼•ç”¨äº† profileï¼Œä½†æœ‰æ™‚å€™ IAM å‚³æ’­éœ€è¦æ™‚é–“
    # é¡¯å¼ç¢ºä¿ role å®Œå…¨å»ºç«‹å¾Œæ‰å»º instance
    depends_on = [aws_iam_role.ec2_role]
  }

  æƒ…å¢ƒï¼šå¿…é ˆç­‰å¤–éƒ¨è³‡æºæº–å‚™å¥½

  # é€™å€‹ null_resource åŸ·è¡Œä¸€äº›åˆå§‹åŒ–è…³æœ¬
  resource "null_resource" "init_database" {
    provisioner "local-exec" {
      command = "python scripts/init_db.py"
    }
  }

  # Application å¿…é ˆç­‰è³‡æ–™åº«åˆå§‹åŒ–å®Œæˆ
  resource "aws_instance" "app" {
    ami           = "ami-123456"
    instance_type = "t2.micro"

    # app å’Œ init_database ä¹‹é–“æ²’æœ‰å±¬æ€§å¼•ç”¨
    # ä½†é‚è¼¯ä¸Š app ä¾è³´ init_database
    depends_on = [null_resource.init_database]
  }

  ---
  ä¾è³´é—œä¿‚çš„è¦–è¦ºåŒ–æ¯”è¼ƒ

  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
  â”‚                     éš±å¼ä¾è³´ (æ¨è–¦ âœ…)                           â”‚
  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
  â”‚                                                                 â”‚
  â”‚   resource "aws_subnet" "public" {                              â”‚
  â”‚     vpc_id = aws_vpc.main.id        â—„â”€â”€ å¼•ç”¨å±¬æ€§ = è‡ªå‹•ä¾è³´     â”‚
  â”‚   }                                                             â”‚
  â”‚                                                                 â”‚
  â”‚   å„ªé»ï¼š                                                        â”‚
  â”‚   â€¢ ç¨‹å¼ç¢¼å³æ–‡ä»¶ï¼Œä¾è³´é—œä¿‚æ¸…æ™°å¯è¦‹                              â”‚
  â”‚   â€¢ é‡æ§‹æ™‚ä¾è³´é—œä¿‚è‡ªå‹•æ›´æ–°                                      â”‚
  â”‚   â€¢ Terraform æœ€ä½³å¯¦è¸                                          â”‚
  â”‚                                                                 â”‚
  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
  â”‚                     é¡¯å¼ä¾è³´ (å¿…è¦æ™‚æ‰ç”¨ âš ï¸)                     â”‚
  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
  â”‚                                                                 â”‚
  â”‚   resource "aws_instance" "app" {                               â”‚
  â”‚     ...                                                         â”‚
  â”‚     depends_on = [null_resource.init]  â—„â”€â”€ æ‰‹å‹•æŒ‡å®š             â”‚
  â”‚   }                                                             â”‚
  â”‚                                                                 â”‚
  â”‚   ä½¿ç”¨æ™‚æ©Ÿï¼š                                                    â”‚
  â”‚   â€¢ ä¾è³´é—œä¿‚ç„¡æ³•ç”¨å±¬æ€§å¼•ç”¨è¡¨é”                                  â”‚
  â”‚   â€¢ æ™‚åºå•é¡Œï¼ˆå¦‚ IAM æœ€çµ‚ä¸€è‡´æ€§ï¼‰                               â”‚
  â”‚   â€¢ Module å±¤ç´šçš„ä¾è³´                                           â”‚
  â”‚                                                                 â”‚
  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

  ---
  ä¸¦è¡ŒåŸ·è¡Œ (Parallelism)

  â˜… Insight â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  - é è¨­ä¸¦è¡Œåº¦ï¼šTerraform é è¨­åŒæ™‚å»ºç«‹/ä¿®æ”¹ 10 å€‹è³‡æº
  - èª¿æ•´ä¸¦è¡Œåº¦ï¼šterraform apply -parallelism=20 æé«˜é€Ÿåº¦
  - é™ä½ä¸¦è¡Œåº¦ï¼šé‡åˆ° API Rate Limit æ™‚å¯é™ä½ -parallelism=2
  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

  ç„¡ä¾è³´é—œä¿‚çš„è³‡æºæœƒä¸¦è¡Œå»ºç«‹ï¼š

  Time â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¶

       â”‚  aws_subnet.a   â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘
       â”‚  aws_subnet.b   â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘
       â”‚  aws_subnet.c   â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘     ä¸¦è¡Œï¼
       â”‚
       â”‚                         aws_instance.web â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ
       â”‚                                               â–²
       â”‚                                               â”‚
       â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                             å¿…é ˆç­‰ subnet éƒ½å»ºå¥½

  ---
  é€²éšï¼šModule ä¹‹é–“çš„ä¾è³´

  module "vpc" {
    source = "./modules/vpc"
  }

  module "database" {
    source = "./modules/database"

    # éš±å¼ä¾è³´ï¼šå¼•ç”¨ vpc module çš„ output
    vpc_id     = module.vpc.vpc_id
    subnet_ids = module.vpc.private_subnet_ids
  }

  module "application" {
    source = "./modules/application"
    
    vpc_id      = module.vpc.vpc_id
    subnet_ids  = module.vpc.public_subnet_ids
    db_endpoint = module.database.endpoint
    
    # é¡¯å¼ä¾è³´ï¼šç¢ºä¿ database module å®Œå…¨å»ºç«‹
    depends_on = [module.database]
  }

  ---
  å¸¸è¦‹ä¾è³´å•é¡Œèˆ‡è§£æ±ºæ–¹æ¡ˆ

  | å•é¡Œ           | åŸå›                  | è§£æ±ºæ–¹æ¡ˆ                            |
  |----------------|----------------------|-------------------------------------|
  | å¾ªç’°ä¾è³´       | A ä¾è³´ Bï¼ŒB åˆä¾è³´ A | é‡æ–°è¨­è¨ˆæ¶æ§‹ï¼Œæ‹†åˆ†è³‡æº              |
  | å»ºç«‹é †åºéŒ¯èª¤   | éš±å¼ä¾è³´æœªæ­£ç¢ºè¨­å®š   | ç¢ºä¿æœ‰å±¬æ€§å¼•ç”¨ï¼Œæˆ–åŠ  depends_on     |
  | åˆªé™¤é †åºéŒ¯èª¤   | è¢«ä¾è³´è³‡æºå…ˆè¢«åˆªé™¤   | è®“ Terraform è‡ªå‹•è™•ç†ï¼ˆä¸è¦æ‰‹å‹•åˆªï¼‰ |
  | IAM æœ€çµ‚ä¸€è‡´æ€§ | AWS IAM å‚³æ’­å»¶é²     | åŠ  depends_on æˆ–ä½¿ç”¨ time_sleep     |

  è™•ç† IAM å‚³æ’­å»¶é²

  resource "aws_iam_role" "lambda" {
    name = "lambda-role"
    # ...
  }

  # ç­‰å¾… IAM å‚³æ’­
  resource "time_sleep" "wait_for_iam" {
    depends_on      = [aws_iam_role.lambda]
    create_duration = "10s"
  }

  resource "aws_lambda_function" "main" {
    function_name = "my-function"
    role          = aws_iam_role.lambda.arn

    depends_on = [time_sleep.wait_for_iam]
  }

  ---
  æŸ¥çœ‹ä¾è³´åœ–çš„æŒ‡ä»¤

  # è¼¸å‡º DOT æ ¼å¼çš„ä¾è³´åœ–
  terraform graph

  # å¦‚æœæœ‰å®‰è£ graphvizï¼Œå¯ä»¥ç”¢ç”Ÿåœ–ç‰‡
  terraform graph | dot -Tpng > graph.png

  # åªé¡¯ç¤ºç‰¹å®šé¡å‹çš„ä¾è³´
  terraform graph -type=plan
  terraform graph -type=apply

  ---

```


7. ä½•ç‚º datasource?
```

  Data Source æ˜¯ä¸€ç¨®ã€Œå”¯è®€ã€çš„è³‡æºæŸ¥è©¢æ©Ÿåˆ¶ï¼Œè®“ä½ å¯ä»¥å¾å¤–éƒ¨ç³»çµ±æˆ–ç¾æœ‰åŸºç¤è¨­æ–½ä¸­ç²å–è³‡è¨Šï¼Œè€Œä¸æœƒå»ºç«‹æˆ–ä¿®æ”¹ä»»ä½•è³‡æºã€‚

  â˜… Insight â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  - Resource vs Data Sourceï¼šresource å»ºç«‹/ç®¡ç†è³‡æºï¼Œdata åªè®€å–è³‡è¨Š
  - ä½¿ç”¨æ™‚æ©Ÿï¼šæŸ¥è©¢ä¸æ˜¯ç”±é€™å€‹ Terraform ç®¡ç†çš„è³‡æºï¼Œæˆ–æŸ¥è©¢å‹•æ…‹è³‡è¨Šï¼ˆå¦‚æœ€æ–° AMIï¼‰
  - é—œéµå­—ï¼šdata è€Œé resource
  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

  ---
  Resource vs Data Source å°æ¯”

  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
  â”‚                         Resource                                â”‚
  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
  â”‚                                                                 â”‚
  â”‚   resource "aws_vpc" "main" {     # å»ºç«‹æ–°çš„ VPC               â”‚
  â”‚     cidr_block = "10.0.0.0/16"                                  â”‚
  â”‚   }                                                             â”‚
  â”‚                                                                 â”‚
  â”‚   è¡Œç‚ºï¼šCreate â†’ Read â†’ Update â†’ Delete (CRUD)                  â”‚
  â”‚   Stateï¼šæœƒè¨˜éŒ„åœ¨ terraform.tfstate ä¸­                          â”‚
  â”‚                                                                 â”‚
  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
  â”‚                        Data Source                              â”‚
  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
  â”‚                                                                 â”‚
  â”‚   data "aws_vpc" "existing" {     # æŸ¥è©¢å·²å­˜åœ¨çš„ VPC           â”‚
  â”‚     id = "vpc-12345678"                                         â”‚
  â”‚   }                                                             â”‚
  â”‚                                                                 â”‚
  â”‚   è¡Œç‚ºï¼šåªæœ‰ Readï¼ˆå”¯è®€æŸ¥è©¢ï¼‰                                   â”‚
  â”‚   Stateï¼šä¸æœƒå»ºç«‹æˆ–ä¿®æ”¹ä»»ä½•é›²ç«¯è³‡æº                             â”‚
  â”‚                                                                 â”‚
  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

  ---
  å¸¸è¦‹ä½¿ç”¨å ´æ™¯

  1ï¸âƒ£ æŸ¥è©¢æœ€æ–°çš„ AMI

  # å‹•æ…‹æŸ¥è©¢æœ€æ–°çš„ Amazon Linux 2 AMI
  data "aws_ami" "amazon_linux" {
    most_recent = true
    owners      = ["amazon"]

    filter {
      name   = "name"
      values = ["amzn2-ami-hvm-*-x86_64-gp2"]
    }

    filter {
      name   = "virtualization-type"
      values = ["hvm"]
    }
  }

  # ä½¿ç”¨æŸ¥è©¢åˆ°çš„ AMI ID
  resource "aws_instance" "web" {
    ami           = data.aws_ami.amazon_linux.id  # â† å‹•æ…‹å–å¾—ï¼
    instance_type = "t2.micro"
  }

  2ï¸âƒ£ å¼•ç”¨ä¸æ˜¯ç”± Terraform ç®¡ç†çš„è³‡æº

  # æŸ¥è©¢æ‰‹å‹•å»ºç«‹çš„ VPCï¼ˆä¸æ˜¯ç”±é€™å€‹ Terraform ç®¡ç†ï¼‰
  data "aws_vpc" "existing" {
    tags = {
      Name = "legacy-vpc"
    }
  }

  # åœ¨é€™å€‹æ—¢æœ‰ VPC ä¸­å»ºç«‹æ–°çš„ Subnet
  resource "aws_subnet" "new" {
    vpc_id     = data.aws_vpc.existing.id  # â† å¼•ç”¨æ—¢æœ‰ VPC
    cidr_block = "10.0.100.0/24"
  }

  3ï¸âƒ£ è·¨å¸³è™Ÿ/è·¨å°ˆæ¡ˆå¼•ç”¨

  # æŸ¥è©¢å¦ä¸€å€‹ AWS å¸³è™Ÿåˆ†äº«çš„ AMI
  data "aws_ami" "shared" {
    owners = ["123456789012"]  # å¦ä¸€å€‹å¸³è™Ÿ ID
    
    filter {
      name   = "name"
      values = ["custom-base-image-*"]
    }
  }

  4ï¸âƒ£ æŸ¥è©¢ç•¶å‰è³‡è¨Š

  # å–å¾—ç•¶å‰ AWS å¸³è™Ÿè³‡è¨Š
  data "aws_caller_identity" "current" {}

  # å–å¾—ç•¶å‰ Region
  data "aws_region" "current" {}

  output "account_id" {
    value = data.aws_caller_identity.current.account_id
  }

  output "region" {
    value = data.aws_region.current.name
  }

  ---
  Data Source èªæ³•è©³è§£

  data "<PROVIDER>_<TYPE>" "<NAME>" {
    # æŸ¥è©¢æ¢ä»¶ï¼ˆç¯©é¸å™¨ï¼‰
    filter {
      name   = "..."
      values = ["..."]
    }
    
    # æˆ–ç›´æ¥æŒ‡å®š ID
    id = "..."
    
    # æˆ–ç”¨ tags æŸ¥è©¢
    tags = {
      Environment = "prod"
    }
  }

  # å¼•ç”¨æ–¹å¼ï¼šdata.<TYPE>.<NAME>.<ATTRIBUTE>
  # ä¾‹å¦‚ï¼šdata.aws_vpc.existing.id

  ---
  å¯¦ç”¨ Data Source ç¯„ä¾‹

  æŸ¥è©¢å¯ç”¨å€åŸŸ (Availability Zones)

  data "aws_availability_zones" "available" {
    state = "available"
  }

  resource "aws_subnet" "public" {
    count             = 2
    vpc_id            = aws_vpc.main.id
    cidr_block        = cidrsubnet(aws_vpc.main.cidr_block, 8, count.index)
    availability_zone = data.aws_availability_zones.available.names[count.index]
  }

  æŸ¥è©¢ IAM Policy

  # å¼•ç”¨ AWS ç®¡ç†çš„ Policy
  data "aws_iam_policy" "admin" {
    name = "AdministratorAccess"
  }

  resource "aws_iam_role_policy_attachment" "admin" {
    role       = aws_iam_role.example.name
    policy_arn = data.aws_iam_policy.admin.arn
  }

  æŸ¥è©¢ Route53 Zone

  data "aws_route53_zone" "main" {
    name = "example.com."
  }

  resource "aws_route53_record" "www" {
    zone_id = data.aws_route53_zone.main.zone_id
    name    = "www.example.com"
    type    = "A"
    ttl     = 300
    records = ["1.2.3.4"]
  }

  ---
  Data Source vs Terraform Remote State

  â˜… Insight â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  - Data Sourceï¼šæŸ¥è©¢é›²ç«¯ APIï¼ˆé©åˆæŸ¥è©¢ä»»ä½•è³‡æºï¼‰
  - Remote Stateï¼šè®€å–å¦ä¸€å€‹ Terraform å°ˆæ¡ˆçš„ Stateï¼ˆé©åˆè·¨å°ˆæ¡ˆå¼•ç”¨ Terraform ç®¡ç†çš„è³‡æºï¼‰
  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

  # æ–¹æ³• 1ï¼šç”¨ Data Source æŸ¥è©¢ VPC
  data "aws_vpc" "network" {
    tags = { Name = "shared-vpc" }
  }

  # æ–¹æ³• 2ï¼šè®€å– Network Team çš„ Terraform State
  data "terraform_remote_state" "network" {
    backend = "s3"
    config = {
      bucket = "terraform-state"
      key    = "network/terraform.tfstate"
      region = "ap-northeast-1"
    }
  }

  # ä½¿ç”¨ remote state çš„ output
  resource "aws_instance" "web" {
    subnet_id = data.terraform_remote_state.network.outputs.public_subnet_id
  }

  ---
  ä½¿ç”¨æµç¨‹åœ–

                      éœ€è¦å¼•ç”¨å¤–éƒ¨è³‡æº
                             â”‚
             â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
             â”‚                               â”‚
             â–¼                               â–¼
     é€™å€‹è³‡æºæ˜¯ç”±å…¶ä»–               é€™å€‹è³‡æºä¸æ˜¯ç”±
     Terraform ç®¡ç†çš„ï¼Ÿ             Terraform ç®¡ç†çš„
             â”‚                               â”‚
             â–¼                               â–¼
     terraform_remote_state          data source
     (è®€å–å…¶ä»–å°ˆæ¡ˆçš„ state)         (ç›´æ¥æŸ¥è©¢é›²ç«¯ API)

  ---
  å¸¸è¦‹ Data Source åˆ—è¡¨

  | Provider | Data Source             | ç”¨é€”                 |
  |----------|-------------------------|----------------------|
  | AWS      | aws_ami                 | æŸ¥è©¢ AMI             |
  | AWS      | aws_vpc                 | æŸ¥è©¢ VPC             |
  | AWS      | aws_availability_zones  | æŸ¥è©¢å¯ç”¨å€åŸŸ         |
  | AWS      | aws_caller_identity     | æŸ¥è©¢ç•¶å‰å¸³è™Ÿ         |
  | AWS      | aws_iam_policy_document | ç”¢ç”Ÿ IAM Policy JSON |
  | GCP      | google_compute_image    | æŸ¥è©¢ Compute Image   |
  | Azure    | azurerm_resource_group  | æŸ¥è©¢ Resource Group  |
  | é€šç”¨     | terraform_remote_state  | è®€å–é ç«¯ State       |
  | é€šç”¨     | local_file              | è®€å–æœ¬åœ°æª”æ¡ˆ         |
  | é€šç”¨     | http                    | ç™¼é€ HTTP è«‹æ±‚       |

  ---
```

8. è‹¥ä½¿ç”¨ terraform å‰µå»ºä¸€å° ec2ï¼Œå¸Œæœ›å°è©² ec2 é€²è¡Œåˆå§‹åŒ–æ“ä½œï¼Œæœ‰å“ªäº›æ–¹å¼åšåˆ°é€™ä»¶äº‹ï¼Œç›¡å¯èƒ½åœ°åˆ—èˆ‰ã€‚

```
EC2 åˆå§‹åŒ–æ–¹å¼å¤§å…¨

  ä½¿ç”¨ Terraform å»ºç«‹ EC2 å¾Œï¼Œæœ‰å¤šç¨®æ–¹å¼å¯ä»¥é€²è¡Œåˆå§‹åŒ–æ“ä½œã€‚ä»¥ä¸‹å¾ç°¡å–®åˆ°è¤‡é›œã€Terraform åŸç”Ÿåˆ°å¤–éƒ¨å·¥å…·å®Œæ•´åˆ—èˆ‰ã€‚

  â˜… Insight â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  - æ ¸å¿ƒæ€è€ƒï¼šåˆå§‹åŒ–åˆ†ç‚ºã€Œä¸€æ¬¡æ€§è¨­å®šã€å’Œã€ŒæŒçºŒæ€§çµ„æ…‹ç®¡ç†ã€å…©ç¨®éœ€æ±‚
  - é¸æ“‡ä¾æ“šï¼šåˆå§‹åŒ–è¤‡é›œåº¦ã€æ˜¯å¦éœ€è¦å†ªç­‰æ€§ã€åœ˜éšŠç¾æœ‰å·¥å…·éˆ
  - æœ€ä½³å¯¦è¸ï¼šè¤‡é›œåˆå§‹åŒ–å»ºè­°ç”¨ é çƒ¤ AMIï¼Œç°¡å–®è¨­å®šç”¨ user_data
  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

  ---
  æ–¹å¼ç¸½è¦½

  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
  â”‚                    EC2 åˆå§‹åŒ–æ–¹å¼å…‰è­œ                            â”‚
  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
  â”‚                                                                 â”‚
  â”‚  ç°¡å–® â—„â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–º è¤‡é›œ â”‚
  â”‚                                                                 â”‚
  â”‚  user_data    provisioner    Ansible     Packer      Kubernetesâ”‚
  â”‚  (cloud-init) (remote-exec)  (å¤–éƒ¨å·¥å…·)  (é çƒ¤ AMI)  (å®¹å™¨åŒ–)   â”‚
  â”‚                                                                 â”‚
  â”‚  é©åˆï¼š                                                         â”‚
  â”‚  â€¢ è£å¹¾å€‹å¥—ä»¶  â€¢ åŸ·è¡Œè…³æœ¬     â€¢ è¤‡é›œçµ„æ…‹   â€¢ æ¨™æº–åŒ–æ˜ åƒ â€¢ å¾®æœå‹™ â”‚
  â”‚  â€¢ æ”¹è¨­å®šæª”    â€¢ ä¸Šå‚³æª”æ¡ˆ     â€¢ å¤šä¼ºæœå™¨   â€¢ å¿«é€Ÿå•Ÿå‹•            â”‚
  â”‚                                                                 â”‚
  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

  ---
  1ï¸âƒ£ User Data (Cloud-Init) â€” æœ€å¸¸ç”¨

  EC2 å•Ÿå‹•æ™‚è‡ªå‹•åŸ·è¡Œçš„è…³æœ¬ï¼Œç”± AWS Cloud-Init è™•ç†

  resource "aws_instance" "web" {
    ami           = "ami-0abcdef1234567890"
    instance_type = "t2.micro"

    # æ–¹æ³• Aï¼šç›´æ¥å¯« shell script
    user_data = <<-EOF
      #!/bin/bash
      yum update -y
      yum install -y httpd
      systemctl start httpd
      systemctl enable httpd
      echo "<h1>Hello from Terraform</h1>" > /var/www/html/index.html
    EOF

    tags = {
      Name = "web-server"
    }
  }

  # æ–¹æ³• Bï¼šä½¿ç”¨ templatefile å‡½æ•¸ï¼ˆæ¨è–¦ï¼‰
  resource "aws_instance" "web" {
    ami           = "ami-0abcdef1234567890"
    instance_type = "t2.micro"

    user_data = templatefile("${path.module}/scripts/init.sh", {
      db_host     = aws_db_instance.main.endpoint
      environment = var.environment
    })
  }

  # scripts/init.sh
  #!/bin/bash
  echo "DB_HOST=${db_host}" >> /etc/environment
  echo "ENV=${environment}" >> /etc/environment
  yum install -y docker
  systemctl start docker

  # æ–¹æ³• Cï¼šä½¿ç”¨ base64 ç·¨ç¢¼
  resource "aws_instance" "web" {
    ami           = "ami-0abcdef1234567890"
    instance_type = "t2.micro"

    user_data_base64 = base64encode(templatefile("${path.module}/scripts/init.sh", {
      config = var.config
    }))
  }

  ---
  2ï¸âƒ£ Cloud-Init é€²éš â€” YAML æ ¼å¼

  resource "aws_instance" "web" {
    ami           = "ami-0abcdef1234567890"
    instance_type = "t2.micro"

    user_data = <<-EOF
      #cloud-config
      package_update: true
      package_upgrade: true

      packages:
        - docker
        - nginx
        - git

      write_files:
        - path: /etc/myapp/config.json
          content: |
            {
              "environment": "production",
              "debug": false
            }
          permissions: '0644'

      runcmd:
        - systemctl start docker
        - systemctl enable docker
        - docker pull nginx:latest
        - docker run -d -p 80:80 nginx
    EOF
  }

  ---
  3ï¸âƒ£ Provisioner â€” Terraform å…§å»º

  remote-execï¼ˆåœ¨é ç«¯åŸ·è¡Œå‘½ä»¤ï¼‰

  resource "aws_instance" "web" {
    ami           = "ami-0abcdef1234567890"
    instance_type = "t2.micro"
    key_name      = aws_key_pair.deployer.key_name

    # éœ€è¦ SSH é€£ç·š
    connection {
      type        = "ssh"
      user        = "ec2-user"
      private_key = file("~/.ssh/id_rsa")
      host        = self.public_ip
    }

    provisioner "remote-exec" {
      inline = [
        "sudo yum update -y",
        "sudo yum install -y nginx",
        "sudo systemctl start nginx"
      ]
    }
  }

  fileï¼ˆä¸Šå‚³æª”æ¡ˆï¼‰

  resource "aws_instance" "web" {
    # ... çœç•¥åŸºæœ¬è¨­å®š ...

    connection {
      type        = "ssh"
      user        = "ec2-user"
      private_key = file("~/.ssh/id_rsa")
      host        = self.public_ip
    }

    # ä¸Šå‚³å–®ä¸€æª”æ¡ˆ
    provisioner "file" {
      source      = "configs/nginx.conf"
      destination = "/tmp/nginx.conf"
    }

    # ä¸Šå‚³æ•´å€‹ç›®éŒ„
    provisioner "file" {
      source      = "app/"
      destination = "/home/ec2-user/app"
    }

    # ä¸Šå‚³å¾ŒåŸ·è¡Œè¨­å®š
    provisioner "remote-exec" {
      inline = [
        "sudo mv /tmp/nginx.conf /etc/nginx/nginx.conf",
        "sudo systemctl restart nginx"
      ]
    }
  }

  local-execï¼ˆåœ¨æœ¬åœ°åŸ·è¡Œå‘½ä»¤ï¼‰

  resource "aws_instance" "web" {
    ami           = "ami-0abcdef1234567890"
    instance_type = "t2.micro"

    # EC2 å»ºç«‹å¾Œï¼Œåœ¨æœ¬åœ°åŸ·è¡Œ Ansible
    provisioner "local-exec" {
      command = "ansible-playbook -i '${self.public_ip},' playbook.yml"
    }
  }

  ---
  4ï¸âƒ£ å¤–éƒ¨çµ„æ…‹ç®¡ç†å·¥å…·

  Ansibleï¼ˆæœ€æµè¡Œï¼‰

  resource "aws_instance" "web" {
    ami           = "ami-0abcdef1234567890"
    instance_type = "t2.micro"
  }

  # ç­‰å¾… SSH å¯ç”¨
  resource "time_sleep" "wait_for_ssh" {
    depends_on      = [aws_instance.web]
    create_duration = "60s"
  }

  # åŸ·è¡Œ Ansible Playbook
  resource "null_resource" "ansible" {
    depends_on = [time_sleep.wait_for_ssh]

    provisioner "local-exec" {
      command = <<-EOT
        ANSIBLE_HOST_KEY_CHECKING=False ansible-playbook \
          -i '${aws_instance.web.public_ip},' \
          -u ec2-user \
          --private-key ~/.ssh/id_rsa \
          playbook.yml
      EOT
    }

    # ç•¶ instance é‡å»ºæ™‚ï¼Œé‡æ–°åŸ·è¡Œ Ansible
    triggers = {
      instance_id = aws_instance.web.id
    }
  }

  Chef / Puppet

  resource "aws_instance" "web" {
    ami           = "ami-0abcdef1234567890"
    instance_type = "t2.micro"

    user_data = <<-EOF
      #!/bin/bash
      # å®‰è£ Chef Client
      curl -L https://omnitruck.chef.io/install.sh | sudo bash
      
      # è¨»å†Šåˆ° Chef Server
      chef-client -r "role[web_server]"
    EOF
  }

  ---
  5ï¸âƒ£ é çƒ¤ AMI (Golden Image) â€” ç”Ÿç”¢ç’°å¢ƒæ¨è–¦

  ä½¿ç”¨ Packer å»ºç«‹å·²ç¶“åˆå§‹åŒ–å¥½çš„ AMI

  # ç”¨ data source å–å¾— Packer å»ºå¥½çš„ AMI
  data "aws_ami" "web_server" {
    most_recent = true
    owners      = ["self"]

    filter {
      name   = "name"
      values = ["web-server-*"]
    }

    filter {
      name   = "tag:Environment"
      values = ["production"]
    }
  }

  resource "aws_instance" "web" {
    ami           = data.aws_ami.web_server.id  # ä½¿ç”¨é çƒ¤ AMI
    instance_type = "t2.micro"
    
    # åªéœ€è¦æ¥µå°‘çš„ user_dataï¼ˆä¾‹å¦‚å–å¾—å‹•æ…‹è¨­å®šï¼‰
    user_data = <<-EOF
      #!/bin/bash
      aws ssm get-parameter --name "/app/config" --output text > /etc/app/config
    EOF
  }

  // packer/web-server.pkr.hcl
  source "amazon-ebs" "web" {
    ami_name      = "web-server-{{timestamp}}"
    instance_type = "t2.micro"
    source_ami    = "ami-0abcdef1234567890"
    ssh_username  = "ec2-user"
  }

  build {
    sources = ["source.amazon-ebs.web"]

    provisioner "shell" {
      scripts = [
        "scripts/install-docker.sh",
        "scripts/install-nginx.sh",
        "scripts/install-monitoring.sh"
      ]
    }
  }

  ---
  6ï¸âƒ£ AWS Systems Manager (SSM)

  resource "aws_instance" "web" {
    ami                  = "ami-0abcdef1234567890"
    instance_type        = "t2.micro"
    iam_instance_profile = aws_iam_instance_profile.ssm.name  # éœ€è¦ SSM æ¬Šé™
  }

  # ä½¿ç”¨ SSM Run Command åŸ·è¡Œå‘½ä»¤
  resource "aws_ssm_association" "install_packages" {
    name = "AWS-RunShellScript"

    targets {
      key    = "InstanceIds"
      values = [aws_instance.web.id]
    }

    parameters = {
      commands = jsonencode([
        "yum update -y",
        "yum install -y nginx",
        "systemctl start nginx"
      ])
    }
  }

  ---
  7ï¸âƒ£ Launch Template + Auto Scaling

  resource "aws_launch_template" "web" {
    name_prefix   = "web-"
    image_id      = data.aws_ami.amazon_linux.id
    instance_type = "t2.micro"

    user_data = base64encode(<<-EOF
      #!/bin/bash
      yum install -y httpd
      systemctl start httpd
      # å¾ S3 ä¸‹è¼‰æ‡‰ç”¨ç¨‹å¼
      aws s3 cp s3://my-bucket/app.tar.gz /opt/
      tar -xzf /opt/app.tar.gz -C /var/www/html/
    EOF
    )

    iam_instance_profile {
      name = aws_iam_instance_profile.web.name
    }
  }

  resource "aws_autoscaling_group" "web" {
    desired_capacity = 2
    max_size         = 4
    min_size         = 1

    launch_template {
      id      = aws_launch_template.web.id
      version = "$Latest"
    }
  }

  ---
  8ï¸âƒ£ å®¹å™¨åŒ–æ–¹æ¡ˆ (ECS / EKS)

  # ä½¿ç”¨ ECS å„ªåŒ–çš„ AMIï¼Œåªéœ€è¦è¨­å®š ECS Agent
  resource "aws_instance" "ecs" {
    ami           = data.aws_ami.ecs_optimized.id
    instance_type = "t2.micro"

    user_data = <<-EOF
      #!/bin/bash
      echo ECS_CLUSTER=${aws_ecs_cluster.main.name} >> /etc/ecs/ecs.config
    EOF
  }

  ---
  æ¯”è¼ƒè¡¨

  | æ–¹å¼                 | è¤‡é›œåº¦ | å†ªç­‰æ€§ | é©ç”¨å ´æ™¯           | åŸ·è¡Œæ™‚æ©Ÿ        |
  |----------------------|--------|--------|--------------------|-----------------|
  | user_data            | â­     | âŒ     | ç°¡å–®åˆå§‹åŒ–         | EC2 é¦–æ¬¡å•Ÿå‹•    |
  | cloud-init YAML      | â­â­   | âŒ     | å¥—ä»¶å®‰è£ã€æª”æ¡ˆå¯«å…¥ | EC2 é¦–æ¬¡å•Ÿå‹•    |
  | remote-exec          | â­â­   | âŒ     | éœ€è¦äº’å‹•/å¤šæ­¥é©Ÿ    | Terraform apply |
  | local-exec + Ansible | â­â­â­ | âœ…     | è¤‡é›œçµ„æ…‹           | Terraform apply |
  | Packer (é çƒ¤ AMI)    | â­â­â­ | âœ…     | ç”Ÿç”¢ç’°å¢ƒ           | å»ºç½®æ™‚æœŸ        |
  | SSM Run Command      | â­â­   | âœ…     | ä¸éœ€ SSH           | ä»»ä½•æ™‚å€™        |
  | Launch Template      | â­â­   | âŒ     | Auto Scaling       | æ¯æ¬¡æ“´å±•        |

  â˜… Insight â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  - é–‹ç™¼ç’°å¢ƒï¼šuser_data è¶³å¤ ï¼Œå¿«é€Ÿè¿­ä»£
  - ç”Ÿç”¢ç’°å¢ƒï¼šPacker é çƒ¤ AMI + æ¥µç°¡ user_dataï¼ˆåªå–å‹•æ…‹è¨­å®šï¼‰
  - å¤§è¦æ¨¡ç®¡ç†ï¼šAnsible + Terraform çµ„åˆï¼Œæˆ–è€ƒæ…® Kubernetes
  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
---
```




# å¯¦ä½œé¡Œ

1. å‰µå»ºä¸€å€‹ project(github repo)ï¼Œä½¿ç”¨ terraform å‰µå»ºä¸€å° EC2ï¼Œä¸¦ä¸”è¨­å®šç›¸é—œè³‡æºï¼Œä¾‹å¦‚ VPCï¼ˆå¯é¸ï¼‰ã€security group(firewall)ã€key pair ç­‰ã€‚ï¼ˆå¯ä»¥å˜—è©¦è·Ÿ ai è©¢å•æ€æ¨£çš„æª”æ¡ˆæ¶æ§‹æ˜¯æ¯”è¼ƒå¥½çš„ã€‚ï¼‰



å»¶çºŒä¸Šä¸€é¡Œï¼Œå˜—è©¦å°‡ä¸€äº›å¯è®Šå‹•çš„åƒæ•¸æ”¹æˆä½¿ç”¨ variables è¼¸å…¥ï¼Œä»¥åŠä½¿ç”¨ output ä¾†è¼¸å‡ºä¸€äº›è³‡è¨Šï¼ˆä¾‹å¦‚ ssh ç™»å…¥æŒ‡ä»¤æˆ–æ˜¯ public ip ç­‰ï¼‰ã€‚
1. å˜—è©¦ä½¿ç”¨ draw.io é€™é¡çš„å·¥å…·ï¼Œç•«ç°¡å–®çš„æ¶æ§‹åœ–ï¼Œä¸¦é™„æ–¼ github readme ä¸­ã€‚



# é€²éšé¡Œ

1. å˜—è©¦äº†è§£ s3 ä½œç‚º remote backend çš„ä½¿ç”¨æ–¹å¼ï¼Œå¦‚æœä¸å«Œéº»ç…©ï¼Œåšå€‹ç¯„ä¾‹å§ï¼
    ```
      â˜… Insight â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    ç‚ºä»€éº¼éœ€è¦ Remote Backendï¼Ÿ

    ç›®å‰ä½ çš„ terraform.tfstate å­˜åœ¨æœ¬æ©Ÿï¼š

    æœ¬æ©Ÿ Backendï¼ˆé è¨­ï¼‰çš„å•é¡Œï¼š
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚ å·¥ç¨‹å¸« A â”‚  â”‚ å·¥ç¨‹å¸« B â”‚
    â”‚ tfstate  â”‚  â”‚ tfstate  â”‚   â† å„è‡ªä¸€ä»½ï¼Œäº’ç›¸ä¸çŸ¥é“å°æ–¹æ”¹äº†ä»€éº¼
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
              ğŸ’¥ è¡çªï¼

    S3 Remote Backendï¼š
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚ å·¥ç¨‹å¸« A â”‚  â”‚ å·¥ç¨‹å¸« B â”‚
    â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”˜
        â”‚              â”‚
        â–¼              â–¼
      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
      â”‚  S3 Bucket          â”‚  â† å–®ä¸€ä¾†æºï¼Œæ‰€æœ‰äººå…±ç”¨
      â”‚  terraform.tfstate  â”‚
      â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
            â”‚
      â”Œâ”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
      â”‚  DynamoDB Table     â”‚  â† State Lockingï¼Œé˜²æ­¢åŒæ™‚ä¿®æ”¹
      â”‚  (Lock)             â”‚
      â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

    ä¸‰å€‹é—œéµå„ªå‹¢ï¼š
    1. åœ˜éšŠå…±äº« â€” æ‰€æœ‰äººè®€åŒä¸€ä»½ state
    2. State Locking â€” DynamoDB é–å®šï¼Œé˜²æ­¢å…©äººåŒæ™‚ terraform apply
    3. ç‰ˆæœ¬æ§åˆ¶ â€” S3 versioning å¯ä»¥å›å¾©åˆ°ä¹‹å‰çš„ state
    â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    ```
2. å˜—è©¦äº†è§£ terragrunt çš„ä½¿ç”¨æ–¹å¼ï¼Œåšå€‹ç¯„ä¾‹åˆ†äº«çµ¦å…¶ä»–åŒå­¸ã€‚
    ```
    â˜… Insight â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€                                                                
    Terragrunt è§£æ±º Terraform çš„ä»€éº¼ç—›é»ï¼Ÿ

    ç´” Terraform çš„å•é¡Œï¼š
    environments/
    â”œâ”€â”€ dev/
    â”‚   â”œâ”€â”€ main.tf          â† 90% è·Ÿ prod ä¸€æ¨£ï¼Œè¤‡è£½è²¼ä¸Š
    â”‚   â”œâ”€â”€ variables.tf     â† ä¸€æ¨£çš„
    â”‚   â””â”€â”€ terraform.tfvars â† åªæœ‰é€™è£¡ä¸åŒ
    â”œâ”€â”€ staging/
    â”‚   â”œâ”€â”€ main.tf          â† åˆè¤‡è£½ä¸€ä»½...
    â”‚   â””â”€â”€ ...
    â””â”€â”€ prod/
        â”œâ”€â”€ main.tf          â† åˆè¤‡è£½ä¸€ä»½...
        â””â”€â”€ ...

    Terragrunt çš„è§£æ³•ï¼šDRYï¼ˆDon't Repeat Yourselfï¼‰
    modules/ec2/             â† å¯«ä¸€æ¬¡ Terraform code
    â”œâ”€â”€ main.tf
    â”œâ”€â”€ variables.tf
    â””â”€â”€ outputs.tf

    environments/
    â”œâ”€â”€ terragrunt.hcl       â† å…±ç”¨è¨­å®šï¼ˆbackendã€providerï¼‰
    â”œâ”€â”€ dev/
    â”‚   â””â”€â”€ terragrunt.hcl   â† åªå¯« dev çš„åƒæ•¸
    â”œâ”€â”€ staging/
    â”‚   â””â”€â”€ terragrunt.hcl   â† åªå¯« staging çš„åƒæ•¸
    â””â”€â”€ prod/
        â””â”€â”€ terragrunt.hcl   â† åªå¯« prod çš„åƒæ•¸

    æ ¸å¿ƒåƒ¹å€¼ï¼š
    1. DRY Backend è¨­å®š â€” backend "s3" {} ä¸ç”¨æ¯å€‹å°ˆæ¡ˆé‡è¤‡å¯«
    2. DRY Provider è¨­å®š â€” provider è¨­å®šå¯«ä¸€æ¬¡ï¼Œå…¨ç’°å¢ƒç¹¼æ‰¿
    3. ç’°å¢ƒå·®ç•°åŒ– â€” æ¯å€‹ç’°å¢ƒåªéœ€å®šç¾©ã€Œè·Ÿåˆ¥äººä¸åŒçš„éƒ¨åˆ†ã€
    4. ä¾è³´ç®¡ç† â€” dependency block å¯ä»¥è·¨æ¨¡çµ„å¼•ç”¨ output
    ```
