# IAM åˆæ¢

## å•ç­”é¡Œ
1. root user è·Ÿ iam user çš„å·®åˆ¥ï¼Ÿ
   1. AWS IAM åŸºç¤æ¦‚å¿µè§£ç­”
        AWS èº«ä»½ç®¡ç†çš„æ ¸å¿ƒæ¦‚å¿µï¼š
        - AWS æ¡ç”¨ã€Œæœ€å°æ¬Šé™åŸå‰‡ã€(Principle of Least Privilege)
        - IAM æ˜¯ AWS å®‰å…¨æ¨¡å‹çš„åŸºçŸ³ï¼Œæ§åˆ¶ã€Œèª°ã€å¯ä»¥åšã€Œä»€éº¼ã€
    2. å·®åˆ¥:
        - Root User:  
          - å»ºç«‹æ™‚æ©Ÿ: å»ºç«‹ AWS å¸³è™Ÿæ™‚è‡ªå‹•ç”¢ç”Ÿ  
          - æ¬Šé™ç¯„åœ: å®Œå…¨æ§åˆ¶æ¬Šï¼Œç„¡æ³•é™åˆ¶   
          - ç™»å…¥æ–¹å¼: Email + å¯†ç¢¼  
          - å»ºè­°ä½¿ç”¨å ´æ™¯:åƒ…é™å¸³è™Ÿç´šåˆ¥æ“ä½œï¼ˆå¦‚é—œé–‰å¸³è™Ÿã€æ›´æ”¹å¸³å–®ï¼‰  
        - IAM User:
          - å»ºç«‹æ™‚æ©Ÿ: ç”± Root æˆ–æœ‰æ¬Šé™çš„ IAM User å»ºç«‹
          - æ¬Šé™ç¯„åœ: å¯è‡ªè¨‚ï¼Œéµå¾ªæœ€å°æ¬Šé™åŸå‰‡  
          - ç™»å…¥æ–¹å¼: å¸³è™Ÿ ID + ä½¿ç”¨è€…åç¨± + å¯†ç¢¼
          - å»ºè­°ä½¿ç”¨å ´æ™¯:æ—¥å¸¸æ“ä½œ          
2. user, group, role, policy å½¼æ­¤é–“çš„é—œä¿‚ç‚ºä½•ï¼Ÿpolicy çš„æ ¼å¼ç‚ºä½•ï¼Ÿ
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
  â”‚                        AWS Account                          â”‚
  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”                 â”‚
  â”‚  â”‚  User   â”‚    â”‚  User   â”‚    â”‚  User   â”‚                 â”‚
  â”‚  â”‚ (Alice) â”‚    â”‚  (Bob)  â”‚    â”‚ (Carol) â”‚                 â”‚
  â”‚  â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”˜                 â”‚
  â”‚       â”‚              â”‚              â”‚                       â”‚
  â”‚       â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                       â”‚
  â”‚                      â–¼                                      â”‚
  â”‚               â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                              â”‚
  â”‚               â”‚    Group     â”‚â—„â”€â”€â”€â”€ Policy (attached)       â”‚
  â”‚               â”‚ (Developers) â”‚                              â”‚
  â”‚               â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                              â”‚
  â”‚                                                             â”‚
  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”                                                â”‚
  â”‚  â”‚  Role   â”‚â—„â”€â”€â”€â”€ Policy (attached)                        â”‚
  â”‚  â”‚(EC2Role)â”‚      å¯è¢« Userã€Serviceã€å…¶ä»– Account å‡è¨­     â”‚
  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                                                â”‚
  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

  å„å…ƒç´ èªªæ˜ï¼š

  - User: ä»£è¡¨ä¸€å€‹äººæˆ–æ‡‰ç”¨ç¨‹å¼ï¼Œæœ‰é•·æœŸæ†‘è­‰
  - Group: User çš„é›†åˆï¼Œæ–¹ä¾¿æ‰¹é‡ç®¡ç†æ¬Šé™
  - Role: å¯è¢«ã€Œå‡è¨­ã€(Assume) çš„èº«ä»½ï¼Œæä¾›è‡¨æ™‚æ†‘è­‰
  - Policy: JSON æ ¼å¼çš„æ¬Šé™æ–‡ä»¶ï¼Œå®šç¾©ã€Œå…è¨±/æ‹’çµ•ã€ä»€éº¼ã€Œå‹•ä½œã€åœ¨ä»€éº¼ã€Œè³‡æºã€ä¸Š

  ---
  - Policy æ ¼å¼
  ```
  {
    "Version": "2012-10-17",
    "Statement": [
      {
        "Sid": "AllowS3ReadAccess",
        "Effect": "Allow",
        "Action": [
          "s3:GetObject",
          "s3:ListBucket"
        ],
        "Resource": [
          "arn:aws:s3:::my-bucket",
          "arn:aws:s3:::my-bucket/*"
        ],
        "Condition": {
          "IpAddress": {
            "aws:SourceIp": "192.168.1.0/24"
          }
        }
      }
    ]
  }
  ```

  Policy é—œéµå…ƒç´ ï¼š

  | å…ƒç´       | èªªæ˜                    |
  |-----------|-------------------------|
  | Version   | å›ºå®šç‚º "2012-10-17"     |
  | Statement | æ¬Šé™è²æ˜çš„é™£åˆ—          |
  | Sid       | (é¸å¡«) è²æ˜è­˜åˆ¥ç¢¼       |
  | Effect    | Allow æˆ– Deny           |
  | Action    | å…è¨±/æ‹’çµ•çš„ API æ“ä½œ    |
  | Resource  | å—å½±éŸ¿çš„ AWS è³‡æº (ARN) |
  | Condition | (é¸å¡«) æ¢ä»¶é™åˆ¶         |

  â˜… Insight â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  Policy è©•ä¼°é‚è¼¯é‡é»ï¼š
  1. é è¨­å…¨éƒ¨ Deny
  2. æ˜ç¢ºçš„ Allow æœƒè¦†è“‹é è¨­ Deny
  3. æ˜ç¢ºçš„ Deny æœƒè¦†è“‹ä»»ä½• Allowï¼ˆDeny å„ªå…ˆï¼‰
  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€



## å¯¦ä½œé¡Œ
1. ç‚º root account å‰µå»º MFA ç™»å…¥ã€‚
å‰µå»º aws credentialï¼ˆaccess key & secretï¼‰ï¼Œä¸¦ä¸”ä½¿ç”¨ aws cli å˜—è©¦å­˜å– ec2 åˆ—è¡¨ï¼ˆå¯ä»¥æ‰‹å‹•å‰µå»ºä¸€å°æ©Ÿå™¨ï¼‰åŠ s3 åˆ—è¡¨ã€‚
    - å®Œæˆ aws-cli çš„ configure æ†‘è­‰è¨­å®š => aws configureã€‚
	- å®‰è£ aws-cli
		`brew install awscli
	- é©—è­‰
		`aws --version`
	- ä½¿ç”¨ **IAM ä½¿ç”¨è€…** å»ºç«‹é‡‘é‘°
	- å› ç‚º **Root å¸³è™Ÿ** ä¸å®‰å…¨ï¼Œä¸å»ºè­°ç›´æ¥ç”¨ã€‚æ­£ç¢ºåšæ³•æ˜¯å»ºç«‹ IAM ä½¿ç”¨è€…ï¼š

		1. ç™»å…¥ AWS Consoleã€‚
		    
		2. æ‰“é–‹ **IAM** æœå‹™ï¼ˆæœå°‹ "IAM"ï¼‰ã€‚
		    
		3. é»é¸å·¦å´çš„ **Users (ä½¿ç”¨è€…)** â†’ **Add users (æ–°å¢ä½¿ç”¨è€…)**ã€‚
		    
		4. çµ¦é€™å€‹ä½¿ç”¨è€…ä¸€å€‹åç¨±ï¼ˆä¾‹å¦‚ `cli-user`ï¼‰ï¼Œå‹¾é¸ **Access key - Programmatic access**ã€‚
		    
		5. åœ¨ **Permissions (æ¬Šé™)**ï¼Œé¸æ“‡ï¼š
		    
		    - **ç›´æ¥é™„åŠ ç¾æœ‰ç­–ç•¥**ï¼Œå¯ä»¥çµ¦ `AdministratorAccess`ï¼ˆæ¸¬è©¦æ–¹ä¾¿ï¼Œä½†æ­£å¼ç’°å¢ƒå»ºè­°ä¾éœ€æ±‚æœ€å°æ¬Šé™ï¼‰ã€‚
		        
		6. å»ºç«‹å®Œæˆå¾Œï¼Œæœƒçœ‹åˆ°ä¸€çµ„ï¼š Access key ID / Secret access key
        

       - âš ï¸ **æ³¨æ„**ï¼šSecret access key **åªæœƒé¡¯ç¤ºä¸€æ¬¡**ï¼Œè¨˜å¾—ä¿å­˜ä¸‹ä¾†ï¼ˆæˆ–ä¸‹è¼‰ `.csv` æ†‘è­‰æª”ï¼‰ã€‚
           - åŸ·è¡Œ`aws configure`
               åœ¨`~/.aws/credentials`
                   ```[private-clairework]
                   aws_access_key_id = YOUR_ACCESS_KEY
                   aws_secret_access_key = YOUR_SECRET_KEY
                   ```
           - export AWS_PROFILE=private-clairework
           - é©—è­‰è¨­å®šæ˜¯å¦æˆåŠŸ
               `aws sts get-caller-identity

    - Step 1: ç¢ºèªä½ çš„ IAM èº«ä»½:
      - aws sts get-caller-identity

    - Step 2: åˆ—å‡º EC2 å¯¦ä¾‹
      - aws ec2 describe-instances --output table

    - Step 3: åˆ—å‡º S3 buckets
      - aws s3 ls


1. å‰µå»ºä¸€å€‹ userï¼Œåç‚º `s3_readonly`ï¼Œä¸¦ä¸”åƒ…çµ¦äºˆå…¶ s3 readonly çš„æ¬Šé™ï¼Œç‚ºæ­¤ user å‰µå»º credential ä¸¦ä¸”è¨­å®šåœ¨ aws å…§ï¼Œä½¿ç”¨ä¸åŒçš„ profile å¯ä»¥æŒ‡å®šç”¨å“ªå€‹ credential è·Ÿ aws æºé€šï¼Œé©—è­‰æ–¹å¼ç‚ºå˜—è©¦å–å¾— ec2 åŠ s3 çš„åˆ—è¡¨ï¼Œå…¶ä¸­ä¸€å€‹æœƒå¤±æ•—ã€‚
   1. å»ºç«‹ä½¿ç”¨è€…
    aws iam create-user --user-name s3_readonly
   2. é™„åŠ  AWS é è¨­çš„ S3 ReadOnly Policy
    aws iam attach-user-policy \
        --user-name s3_readonly \
        --policy-arn arn:aws:iam::aws:policy/AmazonS3ReadOnlyAccess
    - é€™å€‹ Policy åŒ…å«çš„æ¬Šé™ï¼š
        ```
        {
            "Version": "2012-10-17",
            "Statement": [
            {
                "Effect": "Allow",
                "Action": [
                "s3:Get*",
                "s3:List*",
                "s3:Describe*"
                ],
                "Resource": "*"
            }
          ]
        } 
        ```
    3. ç‚º s3_readonly å»ºç«‹æ†‘è­‰
        aws iam create-access-key --user-name s3_readonly
        âš ï¸ é‡è¦ï¼š è«‹è¨˜éŒ„è¼¸å‡ºçš„ AccessKeyId å’Œ SecretAccessKeyï¼ŒSecret åªæœƒé¡¯ç¤ºä¸€æ¬¡ï¼

        è¼¸å‡ºç¯„ä¾‹ï¼š
        ```
        {
            "AccessKey": {
            "UserName": "s3_readonly",
            "AccessKeyId": "AKIAXXXXXXXXXXXXXXXX",
            "SecretAccessKey": "xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx",
            "Status": "Active"
            }
        }
        ```
    4. è¨­å®šæ–°çš„ profile
        aws configure --profile s3_readonly

        è¼¸å…¥å‰›æ‰å–å¾—çš„ï¼š
        - AWS Access Key ID: AKIAXXXXXXXXXXXXXXXX
        - AWS Secret Access Key: xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
        - Default region: ap-northeast-1 (æˆ–ä½ åå¥½çš„å€åŸŸ)
        - Default output format: json
    5. æŸ¥çœ‹ credentials æª”æ¡ˆ
        cat ~/.aws/credentials
    6. ä½¿ç”¨ s3_readonly profile
        aws sts get-caller-identity --profile s3_readonly
        æ¸¬è©¦ï¼šåˆ—å‡º EC2ï¼ˆâŒ æ‡‰è©²å¤±æ•—ï¼‰
        aws ec2 describe-instances --profile s3_readonly

2. å˜—è©¦å‰µå»º inline policyï¼Œä½¿ s3_readonly é€™å€‹ä½¿ç”¨è€…åœ¨æŸå€‹æ™‚é–“å¾Œå°±ç„¡æ³•å­˜å– s3ï¼Œä¸¦ä¸”å›ç­” inline policy å¯ä»¥ç”¨åœ¨å“ªäº›åœ°æ–¹ã€‚
   1. â˜… Insight â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    Inline Policy vs Managed Policyï¼š
       - Managed Policy: ç¨ç«‹å­˜åœ¨ï¼Œå¯é™„åŠ åˆ°å¤šå€‹å¯¦é«”ï¼Œæ–¹ä¾¿é‡è¤‡ä½¿ç”¨
       - Inline Policy: ç›´æ¥åµŒå…¥åœ¨ User/Group/Role å…§ï¼Œèˆ‡å¯¦é«”å…±å­˜äº¡
       - åˆªé™¤ User æ™‚ï¼ŒInline Policy æœƒä¸€ä½µåˆªé™¤ï¼›Managed Policy å‰‡ä¿ç•™
  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    2. Inline Policy å¯ä»¥ç”¨åœ¨å“ªè£¡ï¼Ÿ

        | é™„åŠ å°è±¡ | èªªæ˜             | ä½¿ç”¨å ´æ™¯             |
        |----------|------------------|----------------------|
        | User     | ç›´æ¥é™„åŠ åˆ°ä½¿ç”¨è€… | ç‰¹å®šä½¿ç”¨è€…çš„ä¾‹å¤–æ¬Šé™ |
        | Group    | é™„åŠ åˆ°ç¾¤çµ„       | ç¾¤çµ„å…§æ‰€æœ‰æˆå“¡å…±äº«   |
        | Role     | é™„åŠ åˆ°è§’è‰²       | è§’è‰²çš„ç‰¹æ®Šé™åˆ¶æ¢ä»¶   |
    3. ä½•æ™‚ä½¿ç”¨ Inline Policyï¼Ÿ

     - âœ… æ¬Šé™èˆ‡å¯¦é«”æœ‰åš´æ ¼çš„ 1:1 é—œä¿‚
     - âœ… éœ€è¦ç¢ºä¿æ¬Šé™éš¨å¯¦é«”åˆªé™¤è€Œæ¶ˆå¤±
     - âœ… ç‰¹æ®Šçš„ä¾‹å¤–è¦å‰‡ï¼ˆå¦‚æœ¬ç·´ç¿’çš„æ™‚é–“é™åˆ¶ï¼‰
     - âŒ ä¸é©åˆéœ€è¦é‡è¤‡ä½¿ç”¨çš„é€šç”¨æ¬Šé™

    ---
    4. å»ºç«‹æ™‚é–“é™åˆ¶çš„ Inline Policy

        Policy é‚è¼¯èªªæ˜

        ç›®å‰ç‹€æ…‹ï¼šs3_readonly æœ‰ AmazonS3ReadOnlyAccess (Allow)
        æ–°å¢è¦å‰‡ï¼šåœ¨æŸå€‹æ™‚é–“ä¹‹å¾Œ Deny S3 æ‰€æœ‰æ“ä½œ
        çµæœï¼šDeny å„ªå…ˆæ–¼ Allow â†’ æ™‚é–“åˆ°å¾Œç„¡æ³•å­˜å–

       - æ­¥é©Ÿ 1ï¼šå»ºç«‹ Policy JSON æª”æ¡ˆ
        ```
        cat << 'EOF' > /tmp/s3-time-restriction.json
        {
          "Version": "2012-10-17",
          "Statement": [
            {
              "Sid": "DenyS3AfterExpiration",
              "Effect": "Deny",
              "Action": "s3:*",
              "Resource": "*",
              "Condition": {
                "DateGreaterThan": {
                  "aws:CurrentTime": "2026-01-21T00:00:00Z"
                }
              }
            }
          ]
        }
        EOF
        ```

        âš ï¸ è«‹ä¿®æ”¹æ™‚é–“ï¼šå°‡ 2025-01-21T00:00:00Z æ”¹æˆä½ æƒ³è¦çš„éæœŸæ™‚é–“ï¼ˆUTC æ™‚å€ï¼‰

        æ¸¬è©¦å»ºè­°ï¼š è¨­å®šæˆå¹¾åˆ†é˜å¾Œï¼Œæ–¹ä¾¿å¿«é€Ÿé©—è­‰æ•ˆæœï¼

    - æ­¥é©Ÿ 2ï¼šé™„åŠ  Inline Policy åˆ° User

      ```
        aws iam put-user-policy \
        --user-name s3_readonly \
        --policy-name S3TimeRestriction \
        --policy-document file:///tmp/s3-time-restriction.json
      ```

    - æ­¥é©Ÿ 3ï¼šç¢ºèª Policy å·²é™„åŠ 

      1. åˆ—å‡ºä½¿ç”¨è€…çš„ inline policies
      aws iam list-user-policies --user-name s3_readonly

      2. æŸ¥çœ‹ policy å…§å®¹
      aws iam get-user-policy \
        --user-name s3_readonly \
        --policy-name S3TimeRestriction

    ---
    é©—è­‰æ¸¬è©¦ ğŸ§ª

    æ™‚é–“åˆ°æœŸå‰ï¼š

    - æ‡‰è©²æˆåŠŸ
    aws s3 ls --profile clairework_s3_readonly

    æ™‚é–“åˆ°æœŸå¾Œï¼š

    - æ‡‰è©²å¤±æ•—
    aws s3 ls --profile s3_readonly

    é æœŸéŒ¯èª¤ï¼š
    An error occurred (AccessDenied) when calling the ListBuckets operation: Access Denied

    ---
    å¸¸ç”¨çš„æ™‚é–“æ¢ä»¶é‹ç®—å­

    | Condition             | èªªæ˜         | ç¯„ä¾‹ç”¨é€”         |
    |-----------------------|--------------|------------------|
    | DateGreaterThan       | æ™šæ–¼æŒ‡å®šæ™‚é–“ | éæœŸå¾Œæ‹’çµ•       |
    | DateLessThan          | æ—©æ–¼æŒ‡å®šæ™‚é–“ | åªåœ¨æŸæ—¥æœŸå‰æœ‰æ•ˆ |
    | DateEquals            | ç­‰æ–¼æŒ‡å®šæ—¥æœŸ | åªåœ¨ç‰¹å®šæ—¥æœŸæœ‰æ•ˆ |
    | DateGreaterThanEquals | å¤§æ–¼ç­‰æ–¼     | å¾æŸæ™‚é–“é–‹å§‹ç”Ÿæ•ˆ |
    | DateLessThanEquals    | å°æ–¼ç­‰æ–¼     | æˆªæ­¢æ—¥æœŸ         |

    é€²éšç¯„ä¾‹ï¼šè¨­å®šæœ‰æ•ˆæœŸé–“ï¼ˆé–‹å§‹ + çµæŸï¼‰
    ```
    {
      "Version": "2012-10-17",
      "Statement": [
        {
          "Sid": "AllowS3OnlyDuringValidPeriod",
          "Effect": "Deny",
          "Action": "s3:*",
          "Resource": "*",
          "Condition": {
            "DateGreaterThan": {
              "aws:CurrentTime": "2025-01-31T23:59:59Z"
            }
          }
        },
        {
          "Sid": "DenyBeforeStartDate",
          "Effect": "Deny",
          "Action": "s3:*",
          "Resource": "*",
          "Condition": {
            "DateLessThan": {
              "aws:CurrentTime": "2025-01-21T00:00:00Z"
            }
          }
        }
      ]
    }
    ```

    ---
    æ¸…ç†ï¼ˆæ¸¬è©¦å®Œæˆå¾Œï¼‰
    - ç§»é™¤ inline policy
        aws iam delete-user-policy \
          --user-name s3_readonly \
          --policy-name S3TimeRestriction



4. å˜—è©¦å‰µå»º EC2ï¼Œä¸¦ä¸”ç‚ºå…¶å‰µå»ºä¸€å€‹ S3ReadOnlyRole çš„ roleï¼Œä½¿ ec2 ä¸Šå¯ä»¥ä½¿ç”¨ aws cliï¼ˆæˆ–æ˜¯ sdkï¼‰ å­˜å– s3 è³‡æºï¼Œä¸¦ä¸”ä¸éœ€è¦è¨­å®š access keyã€‚ï¼ˆé€™é¡Œå¯ä»¥ç”¨ aws linuxï¼Œå› ç‚ºä»–æœ‰å…§å»º aws cliï¼‰
  å¯¦ä½œï¼šEC2 Instance Role - ç„¡éœ€ Access Key å­˜å– S3

    â˜… Insight â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    ç‚ºä»€éº¼ EC2 æ‡‰è©²ç”¨ Role è€Œé Access Keyï¼Ÿ
    - å®‰å…¨æ€§ï¼šRole æä¾›è‡¨æ™‚æ†‘è­‰ï¼Œè‡ªå‹•è¼ªæ›ï¼Œç„¡éœ€ç®¡ç†é•·æœŸå¯†é‘°
    - ä¾¿åˆ©æ€§ï¼šEC2 è‡ªå‹•å¾ Metadata Service å–å¾—æ†‘è­‰
    - æœ€ä½³å¯¦è¸ï¼šAWS å®˜æ–¹å¼·çƒˆå»ºè­°ï¼Œé¿å…å°‡ Access Key æ”¾åœ¨ EC2 ä¸Š
    â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

      ---
      æ¦‚å¿µåœ–è§£
      ```
      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
      â”‚                         AWS                                 â”‚
      â”‚                                                             â”‚
      â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”            â”‚
      â”‚   â”‚  IAM Role    â”‚         â”‚   S3 Bucket      â”‚            â”‚
      â”‚   â”‚S3ReadOnlyRoleâ”‚         â”‚                  â”‚            â”‚
      â”‚   â”‚              â”‚         â””â”€â”€â”€â”€â”€â”€â”€â”€â–²â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜            â”‚
      â”‚   â”‚ Trust Policy â”‚                  â”‚                      â”‚
      â”‚   â”‚ (EC2å¯å‡è¨­)  â”‚                  â”‚ å­˜å–                  â”‚
      â”‚   â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜                  â”‚                      â”‚
      â”‚          â”‚                          â”‚                      â”‚
      â”‚          â”‚ é™„åŠ                       â”‚                      â”‚
      â”‚          â–¼                          â”‚                      â”‚
      â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    å–å¾—è‡¨æ™‚æ†‘è­‰   â”‚                      â”‚
      â”‚   â”‚   Instance   â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–ºâ”‚                      â”‚
      â”‚   â”‚   Profile    â”‚   (è‡ªå‹•)         â”‚                      â”‚
      â”‚   â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜                  â”‚                      â”‚
      â”‚          â”‚                          â”‚                      â”‚
      â”‚          â”‚ é—œè¯                      â”‚                      â”‚
      â”‚          â–¼                          â”‚                      â”‚
      â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                  â”‚                      â”‚
      â”‚   â”‚     EC2      â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                      â”‚
      â”‚   â”‚  (Amazon     â”‚   aws s3 ls                             â”‚
      â”‚   â”‚   Linux)     â”‚   ç„¡éœ€è¨­å®š credentials!                  â”‚
      â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                                         â”‚
      â”‚                                                             â”‚
      â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
      ```
      ---
    - æ­¥é©Ÿä¸€ï¼šå»ºç«‹ IAM Role

      - 1.1 å»ºç«‹ Trust Policyï¼ˆä¿¡ä»»æ”¿ç­–ï¼‰

        é€™å‘Šè¨´ AWSã€Œèª°å¯ä»¥å‡è¨­é€™å€‹ Roleã€ï¼š
        ```
        cat << 'EOF' > /tmp/ec2-trust-policy.json
        {
            "Version": "2012-10-17",
            "Statement": [
              {
                "Effect": "Allow",
                "Principal": {
                  "Service": "ec2.amazonaws.com"
                },
                "Action": "sts:AssumeRole"
              }
            ]
          }
        EOF
        ```
       - 1.2 å»ºç«‹ Role
             aws iam create-role \
               --role-name S3ReadOnlyRole \
               --assume-role-policy-document file:///tmp/ec2-trust-policy.json \
               --description "Allows EC2 instances to read S3"

       - 1.3 é™„åŠ  S3 å”¯è®€æ¬Šé™

               aws iam attach-role-policy \
                 --role-name S3ReadOnlyRole \
                 --policy-arn arn:aws:iam::aws:policy/AmazonS3ReadOnlyAccess

     - æ­¥é©ŸäºŒï¼šå»ºç«‹ Instance Profile

        Instance Profile æ˜¯ Role å’Œ EC2 ä¹‹é–“çš„ã€Œæ©‹æ¨‘ã€ï¼ŒEC2 ä¸èƒ½ç›´æ¥ä½¿ç”¨ Roleï¼Œå¿…é ˆé€é Instance Profileã€‚

         - å»ºç«‹ Instance Profile
         aws iam create-instance-profile \
           --instance-profile-name S3ReadOnlyProfile

         - å°‡ Role åŠ å…¥ Instance Profile
          aws iam add-role-to-instance-profile \
            --instance-profile-name S3ReadOnlyProfile \
            --role-name S3ReadOnlyRole

      ---
      - æ­¥é©Ÿä¸‰ï¼šå•Ÿå‹• EC2ï¼ˆé™„åŠ  Roleï¼‰

        ä½¿ç”¨ AWS Consoleï¼ˆå»ºè­°åˆå­¸è€…ï¼‰

        1. EC2 â†’ Launch Instance
        2. é¸æ“‡ Amazon Linux 2023 AMI
        3. Instance type: t2.microï¼ˆå…è²»æ–¹æ¡ˆï¼‰
        4. Key pair: é¸æ“‡æˆ–å»ºç«‹ä¸€å€‹ï¼ˆç”¨æ–¼ SSHï¼‰
        5. Advanced details â†’ IAM instance profile: é¸æ“‡ S3ReadOnlyProfile
        6. Launch!
        ---
      - æ­¥é©Ÿå››ï¼šé©—è­‰ ğŸ§ª

        4.1 SSH é€²å…¥ EC2

        ssh -i your-key.pem ec2-user@<EC2-Public-IP>

        4.2 ç¢ºèªæ²’æœ‰è¨­å®š credentials

        - æ‡‰è©²æ˜¯ç©ºçš„æˆ–ä¸å­˜åœ¨
        cat ~/.aws/credentials

        - æŸ¥çœ‹ç’°å¢ƒè®Šæ•¸ï¼ˆæ‡‰è©²æ²’æœ‰ AWS keyï¼‰
        env | grep AWS

        4.3 æ¸¬è©¦ S3 å­˜å–ï¼ˆæ‡‰è©²æˆåŠŸï¼ï¼‰

        - ç¢ºèªèº«ä»½ - æœƒé¡¯ç¤º assumed-role/S3ReadOnlyRole
        aws sts get-caller-identity

        - åˆ—å‡º S3 buckets
        aws s3 ls

        4.4 æ¸¬è©¦ EC2 å­˜å–ï¼ˆæ‡‰è©²å¤±æ•—ï¼ï¼‰

        - Role æ²’æœ‰ EC2 æ¬Šé™
        aws ec2 describe-instances

        ---
        åŸç†è§£æï¼šEC2 å¦‚ä½•å–å¾—æ†‘è­‰ï¼Ÿ

        - åœ¨ EC2 å…§åŸ·è¡Œï¼ŒæŸ¥çœ‹ Metadata Service æä¾›çš„è‡¨æ™‚æ†‘è­‰
          æ­¥é©Ÿ 1ï¼šå–å¾— Token

              TOKEN=$(curl -X PUT "http://169.254.169.254/latest/api/token" \
                -H "X-aws-ec2-metadata-token-ttl-seconds: 21600" \
                -s)

          æ­¥é©Ÿ 2ï¼šä½¿ç”¨ Token æŸ¥è©¢ Metadata

        - æŸ¥çœ‹ Role åç¨±
        curl -H "X-aws-ec2-metadata-token: $TOKEN" \
          http://169.254.169.254/latest/meta-data/iam/security-credentials/

        - æŸ¥çœ‹è‡¨æ™‚æ†‘è­‰
        curl -H "X-aws-ec2-metadata-token: $TOKEN" \
          http://169.254.169.254/latest/meta-data/iam/security-credentials/S3ReadOnlyRole

        ---
        â˜… Insight â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        IAM Role çš„é—œéµæ¦‚å¿µï¼š

        | å…ƒç´               | èªªæ˜                            |
        |-------------------|---------------------------------|
        | Trust Policy      | å®šç¾©ã€Œèª°ã€å¯ä»¥ Assume é€™å€‹ Role |
        | Permission Policy | å®šç¾© Role æ“æœ‰ã€Œä»€éº¼ã€æ¬Šé™      |
        | Instance Profile  | EC2 å°ˆç”¨çš„ Role è¼‰é«”            |
        | è‡¨æ™‚æ†‘è­‰          | è‡ªå‹•è¼ªæ›ï¼ˆé€šå¸¸ 1-6 å°æ™‚éæœŸï¼‰   |

        é¢è©¦å¸¸è€ƒï¼š User å’Œ Role çš„å·®åˆ¥ï¼Ÿ
        - Userï¼šé•·æœŸèº«ä»½ï¼Œç”¨æ–¼äººæˆ–æ‡‰ç”¨ç¨‹å¼
        - Roleï¼šè‡¨æ™‚èº«ä»½ï¼Œå¯è¢«ã€Œå‡è¨­ã€ï¼Œç”¨æ–¼æœå‹™æˆ–è·¨å¸³è™Ÿå­˜å–
        â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

        ---
        æ¸…ç†è³‡æº

        -  çµ‚æ­¢ EC2 instance
        aws ec2 terminate-instances --instance-ids <instance-id>

        -  ç­‰å¾… EC2 çµ‚æ­¢å¾Œï¼Œæ¸…ç† IAM è³‡æº
            ``` 
              aws iam remove-role-from-instance-profile \
                --instance-profile-name S3ReadOnlyProfile \
                --role-name S3ReadOnlyRole

              aws iam delete-instance-profile \
                --instance-profile-name S3ReadOnlyProfile

              aws iam detach-role-policy \
                --role-name S3ReadOnlyRole \
                --policy-arn arn:aws:iam::aws:policy/AmazonS3ReadOnlyAccess

              aws iam delete-role --role-name S3ReadOnlyRole
            ```